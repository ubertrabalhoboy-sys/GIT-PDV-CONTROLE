<script>
document.addEventListener('DOMContentLoaded', () => {

    const firebaseConfig = {
        apiKey: "AIzaSyByZ1r41crqOadLXwHH2v9LgveyCkL6erE",
        authDomain: "pdv-vendas-8a65a.firebaseapp.com",
        projectId: "pdv-vendas-8a65a",
        storageBucket: "pdv-vendas-8a65a.appspot.com",
        messagingSenderId: "37533259212",
        appId: "1:37533259212:web:9e79fecb52aa2b4765b969",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let state = { loggedInUser: null, currentView: '', currentOrder: [], db: { users: [], settings: { storeName: "Minha Loja", goals: {} }, sales: [] } };
    let selectedUserForLogin = null;
    let vendasChartInstance = null;
    let pagamentoChartInstance = null;

    // --- UTILITY FUNCTIONS ---
    async function fetchData(collectionName, field, operator, value) {
        try {
            let query = db.collection(collectionName);
            if (field && operator && value !== undefined) {
                query = query.where(field, operator, value);
            }
            const snapshot = await query.get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error(`Error fetching from '${collectionName}':`, error);
            showToast(`Failed to load ${collectionName}.`, 'error');
            return [];
        }
    }

    async function saveData(collectionName, data, docId = null) {
        try {
            const docRef = docId ? db.collection(collectionName).doc(docId) : db.collection(collectionName).doc();
            await docRef.set(data, { merge: true });
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error(`Error saving to '${collectionName}':`, error);
            showToast('Error saving data.', 'error');
            return { success: false };
        }
    }
    
    async function deleteData(collectionName, docId) {
        try {
            await db.collection(collectionName).doc(docId).delete();
            return { success: true };
        } catch (error) {
            console.error(`Error deleting doc '${docId}' from '${collectionName}':`, error);
            showToast('Error deleting data.', 'error');
            return { success: false };
        }
    }

    const applyTheme=(t)=>{const h=document.documentElement;if(t==='dark'){h.classList.add('dark');document.getElementById('theme-icon-moon').classList.add('hidden');document.getElementById('theme-icon-sun').classList.remove('hidden')}else{h.classList.remove('dark');document.getElementById('theme-icon-moon').classList.remove('hidden');document.getElementById('theme-icon-sun').classList.add('hidden')}};
    const formatCurrency=v=>new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v || 0);
    
    // **FIXED FUNCTION**: This function is now robust and handles different date types.
    const formatDate = d => {
        if (!d) return '';
        // Handles Firestore Timestamp objects
        if (d.seconds) {
            return new Date(d.seconds * 1000).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
        }
        // Handles standard JS Date objects or date strings
        return new Date(d).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
    };

    const getDayOfWeek=d=>new Date(d).toLocaleDateString('pt-BR',{weekday:'short'}).replace('.','').slice(0,3);
    const showToast=(m,t='success')=>{const e=document.createElement('div');e.className=`fixed bottom-5 right-5 ${t==='success'?'bg-green-500':'bg-red-500'} text-white py-2 px-4 rounded-lg shadow-lg z-[70] animate-bounce`;e.textContent=m;document.body.appendChild(e);setTimeout(()=>e.remove(),3000)};
    const showConfirmModal=(m,onConfirm)=>{const M=document.getElementById('confirm-modal');M.querySelector('#confirm-modal-message').textContent=m;M.classList.remove('hidden');const c=M.querySelector('#confirm-modal-confirm'),n=M.querySelector('#confirm-modal-cancel');const h=()=>{onConfirm();hide()};const k=()=>hide();const hide=()=>{M.classList.add('hidden');c.removeEventListener('click',h);n.removeEventListener('click',k)};c.addEventListener('click',h,{once:true});n.addEventListener('click',k,{once:true})};

    // --- INITIALIZATION AND LOGIN ---
    async function loadInitialData() {
        const [users, settingsDoc, storeNameDoc] = await Promise.all([
            fetchData('users'),
            db.collection('settings').doc('goals').get(),
            db.collection('settings').doc('store').get()
        ]);

        if (users.length === 0) {
            const gerente = { name: 'gerente', password: '123', role: 'gerente' };
            const { success } = await saveData('users', gerente, 'gerente');
            if (success) state.db.users.push({ id: 'gerente', ...gerente });
        } else {
            state.db.users = users;
        }

        if (settingsDoc.exists) state.db.settings.goals = settingsDoc.data();
        if (storeNameDoc.exists) state.db.settings.storeName = storeNameDoc.data().name;
        
        // Fetch all sales after login, based on role
    }

    function renderLoginScreen(){
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        document.getElementById('user-selection-view').classList.remove('hidden');
        document.getElementById('password-view').classList.add('hidden');
        document.getElementById('login-store-name').textContent = state.db.settings.storeName;

        if (state.db.users.length > 0) {
            state.db.users.forEach(user => {
                const userButton = document.createElement('button');
                userButton.className = 'flex flex-col items-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-primary-100 dark:hover:bg-primary-900/50 transition-colors duration-200 transform hover:scale-105 border border-gray-200 dark:border-gray-700';
                userButton.dataset.username = user.name;
                userButton.innerHTML = `<div class="w-16 h-16 mb-2 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center text-gray-500 dark:text-gray-300 text-3xl font-bold">${user.name.charAt(0).toUpperCase()}</div><span class="font-semibold text-gray-800 dark:text-gray-200 text-center">${user.name}</span>`;
                userList.appendChild(userButton);
            });
        } else {
            userList.innerHTML = '<div class="col-span-full text-center text-gray-500"><div class="loader"></div>Carregando usuários...</div>';
        }
        lucide.createIcons();
    }
    
    const logout = async () => {
        state.loggedInUser = null; selectedUserForLogin = null; state.db.sales = [];
        document.getElementById('app').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        await loadInitialData();
        renderLoginScreen();
    };

    const initializeAppUI = async () => {
        const user = state.loggedInUser;
        document.getElementById('store-name-sidebar').textContent = state.db.settings.storeName;
        document.getElementById('username-sidebar').textContent = user.name;
        document.getElementById('user-icon').textContent = user.name.charAt(0).toUpperCase();

        // Fetch sales data relevant to the logged-in user
        if (user.role === 'gerente') {
            state.db.sales = await fetchData('sales');
        } else {
            state.db.sales = await fetchData('sales', 'sellerId', '==', user.id);
        }

        const createMenuItem=(v,i,t)=>`<li><a href="#" data-view="${v}" class="flex items-center p-2 text-gray-300 rounded-lg hover:bg-gray-700 hover:text-white group transition-colors"><i data-lucide="${i}" class="w-5 h-5"></i><span class="ml-3">${t}</span></a></li>`;
        const createLogoutItem = () => `<li class="pt-2 mt-2 border-t border-gray-700"><button data-action="logout" class="w-full flex items-center p-2 text-red-400 rounded-lg hover:bg-red-500 hover:text-white group transition-colors"><i data-lucide="log-out" class="w-5 h-5"></i><span class="ml-3">Sair</span></button></li>`;
        const vM=document.getElementById('vendedor-menu'), gM=document.getElementById('gerente-menu');
        vM.innerHTML = ''; gM.innerHTML = '';

        if(user.role==='vendedor'){
            vM.innerHTML = createMenuItem('caixa','shopping-basket','Caixa') + createMenuItem('pedidos','list-ordered','Pedidos') + createMenuItem('relatorios','bar-chart-2','Relatórios') + createLogoutItem();
            vM.classList.remove('hidden'); gM.classList.add('hidden');
            switchView('caixa');
        } else {
            gM.innerHTML = createMenuItem('pedidos','list-ordered','Pedidos') + createMenuItem('relatorios','area-chart','Relatórios') + createMenuItem('configuracoes','settings','Configurações') + createLogoutItem();
            gM.classList.remove('hidden'); vM.classList.add('hidden');
            switchView('pedidos');
        }

        document.getElementById('sidebar').addEventListener('click', e => {
            const link = e.target.closest('a[data-view]'), logoutBtn = e.target.closest('button[data-action="logout"]');
            if (link) { e.preventDefault(); switchView(link.dataset.view); }
            if (logoutBtn) { logout(); }
        });
        lucide.createIcons();
    };

    const switchView = (viewId) => {
        if (vendasChartInstance) vendasChartInstance.destroy();
        if (pagamentoChartInstance) pagamentoChartInstance.destroy();

        document.querySelectorAll('.view').forEach(v => v.classList.remove('active', 'fade-in'));
        const activeView = document.getElementById(`${viewId}-view`);
        if (activeView) {
            activeView.innerHTML = document.getElementById(`${viewId}-template`).innerHTML;
            activeView.classList.add('active', 'fade-in'); 
            state.currentView = viewId;
            const link = document.querySelector(`#sidebar a[data-view="${viewId}"]`);
            if(link) {
               document.getElementById('current-view-title').textContent = link.querySelector('span').textContent;
               document.querySelectorAll('#sidebar ul li a').forEach(l => l.classList.remove('bg-primary-600', 'text-white'));
               link.classList.add('bg-primary-600', 'text-white');
            }
            lucide.createIcons();
            switch(viewId) {
                case 'caixa': renderCaixa(); break;
                case 'pedidos': renderPedidos(); break;
                case 'relatorios': renderRelatorios(); break;
                case 'configuracoes': renderConfiguracoes(); break;
            }
        }
        showMobileMenu(false);
    };
    
    const sidebar=document.getElementById('sidebar'), overlay=document.getElementById('sidebar-overlay');
    const showMobileMenu=s=>{if(s){sidebar.classList.remove('-translate-x-full');overlay.classList.remove('hidden')}else{sidebar.classList.add('-translate-x-full');overlay.classList.add('hidden')}};

    function showWhatsAppModal(saleId, clientName, clientPhone) {
        const modal = document.getElementById('whatsapp-data-modal');
        modal.querySelector('#whatsapp-sale-id').value = saleId;
        modal.querySelector('#client-name-whatsapp').value = clientName || '';
        modal.querySelector('#client-phone-whatsapp').value = clientPhone || '';
        modal.classList.remove('hidden');
    }

    function hideWhatsAppModal() { document.getElementById('whatsapp-data-modal').classList.add('hidden'); }

    document.getElementById('whatsapp-data-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const saleId = document.getElementById('whatsapp-sale-id').value;
        const clientName = document.getElementById('client-name-whatsapp').value;
        const clientPhone = document.getElementById('client-phone-whatsapp').value;
        await saveData('sales', { clientName, clientPhone }, saleId);
        showToast('Dados do cliente salvos!');
        
        const saleIndex = state.db.sales.findIndex(s => s.id === saleId);
        if (saleIndex > -1) {
            state.db.sales[saleIndex].clientName = clientName;
            state.db.sales[saleIndex].clientPhone = clientPhone;
        }
        hideWhatsAppModal();
    });

    document.getElementById('skip-whatsapp-button').addEventListener('click', hideWhatsAppModal);
    
    // --- FULLY IMPLEMENTED VIEWS ---

    function renderCaixa() {
        const addItemForm = document.getElementById('add-item-form');
        const orderItemsContainer = document.getElementById('current-order-items');
        const orderTotalEl = document.getElementById('current-order-total');
        const finalizeButton = document.getElementById('finalize-order-button');
        const noItemsMessage = document.getElementById('no-items-message');

        const updateOrderView = () => {
            orderItemsContainer.innerHTML = '';
            if (state.currentOrder.length === 0) {
                noItemsMessage.style.display = 'block';
                finalizeButton.disabled = true;
            } else {
                noItemsMessage.style.display = 'none';
                finalizeButton.disabled = false;
                state.currentOrder.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-3 rounded-lg';
                    itemEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${item.exchange}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-semibold">${formatCurrency(item.value)}</span>
                            <button data-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>`;
                    orderItemsContainer.appendChild(itemEl);
                });
            }
            const total = state.currentOrder.reduce((acc, item) => acc + item.value, 0);
            orderTotalEl.textContent = formatCurrency(total);
            lucide.createIcons();
        };

        addItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('item-name').value;
            const value = parseFloat(document.getElementById('item-value').value);
            const exchange = document.getElementById('item-exchange').value;
            if (name && value > 0) {
                state.currentOrder.push({ name, value, exchange });
                updateOrderView();
                addItemForm.reset();
            }
        });

        orderItemsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-item-btn')) {
                const index = e.target.closest('.remove-item-btn').dataset.index;
                state.currentOrder.splice(index, 1);
                updateOrderView();
            }
        });
        
        finalizeButton.addEventListener('click', () => {
            // Logic to open finalize modal would go here
            showToast('Função de finalização ainda não implementada.');
            const total = state.currentOrder.reduce((acc, item) => acc + item.value, 0);

            // Mock finalization for now
            const newSale = {
                items: state.currentOrder,
                total: total,
                seller: state.loggedInUser.name,
                sellerId: state.loggedInUser.id,
                date: firebase.firestore.FieldValue.serverTimestamp(),
                paymentMethod: 'Pix' // Mock payment method
            };

            showConfirmModal(`Finalizar pedido de ${formatCurrency(total)}?`, async () => {
                 const {success, id} = await saveData('sales', newSale);
                 if (success) {
                    showToast('Venda registrada com sucesso!');
                    state.currentOrder = [];
                    updateOrderView();
                    // Fetch the newly created sale to get server-generated timestamp
                    const savedSale = await db.collection('sales').doc(id).get();
                    state.db.sales.push({id, ...savedSale.data()});
                    showWhatsAppModal(id, '', '');
                 }
            });
        });

        updateOrderView();
    }

    async function renderPedidos(filteredSales = null) {
        const salesToRender = filteredSales || state.db.sales;
        const tableBody = document.getElementById('orders-table-body');
        const noOrdersFound = document.getElementById('no-orders-found');
        tableBody.innerHTML = '';

        if (salesToRender.length === 0) {
            noOrdersFound.classList.remove('hidden');
        } else {
            noOrdersFound.classList.add('hidden');
            salesToRender.sort((a, b) => b.date.seconds - a.date.seconds).forEach(sale => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600';
                tr.innerHTML = `
                    <td class="px-6 py-4">${sale.clientName || 'N/A'}</td>
                    <td class="px-6 py-4">${formatDate(sale.date)}</td>
                    <td class="px-6 py-4">${sale.paymentMethod}</td>
                    <td class="px-6 py-4 text-right font-semibold">${formatCurrency(sale.total)}</td>
                    <td class="px-6 py-4 text-center">
                        <button data-id="${sale.id}" class="details-btn text-primary-500 hover:underline">Ver</button>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button data-id="${sale.id}" class="whatsapp-btn text-green-500 hover:underline">Recibo</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }
        lucide.createIcons();

        // Add event listeners for buttons
        tableBody.addEventListener('click', e => {
            const saleId = e.target.dataset.id;
            if (!saleId) return;

            const sale = state.db.sales.find(s => s.id === saleId);
            if (e.target.classList.contains('whatsapp-btn')) {
                showWhatsAppModal(sale.id, sale.clientName, sale.clientPhone);
            }
            if (e.target.classList.contains('details-btn')) {
                alert(`Detalhes do Pedido ${sale.id}:\n\nVendedor: ${sale.seller}\nTotal: ${formatCurrency(sale.total)}\nItens:\n${sale.items.map(i => `- ${i.name} (${formatCurrency(i.value)})`).join('\n')}`);
            }
        });
        
        // Filter logic
        const filterForm = document.getElementById('filter-form');
        filterForm.addEventListener('submit', e => {
            e.preventDefault();
            const date = document.getElementById('filter-date').value;
            const payment = document.getElementById('filter-payment').value;
            
            const filtered = state.db.sales.filter(sale => {
                let match = true;
                if (date) {
                    const saleDate = new Date(sale.date.seconds * 1000).toISOString().split('T')[0];
                    match = match && (saleDate === date);
                }
                if (payment !== 'Todos') {
                    match = match && (sale.paymentMethod === payment);
                }
                return match;
            });
            renderPedidos(filtered);
        });

        filterForm.addEventListener('reset', () => renderPedidos());

        // Dashboard cards
        const totalValue = salesToRender.reduce((sum, sale) => sum + sale.total, 0);
        document.getElementById('pedidos-finalizados').textContent = salesToRender.length;
        document.getElementById('valor-total').textContent = formatCurrency(totalValue);
        document.getElementById('ticket-medio').textContent = formatCurrency(salesToRender.length > 0 ? totalValue / salesToRender.length : 0);
    }
    
    async function renderRelatorios() {
        // Implementation for Relatorios view... (can be built out later)
        showToast("Página de Relatórios em construção.", "info");
    }
    
    function renderConfiguracoes() {
        const storeNameInput = document.getElementById('config-store-name');
        const metaDiariaInput = document.getElementById('meta-diaria');
        const metaSemanalInput = document.getElementById('meta-semanal');
        const metaMensalInput = document.getElementById('meta-mensal');
        const saveSettingsButton = document.getElementById('save-settings-button');
        const addVendedorForm = document.getElementById('add-vendedor-form');
        const vendedoresList = document.getElementById('vendedores-list');
        const zerarVendasButton = document.getElementById('zerar-vendas-button');
        const exportDiaButton = document.getElementById('export-dia');
        const exportSemanaButton = document.getElementById('export-semana');

        storeNameInput.value = state.db.settings.storeName;
        metaDiariaInput.value = state.db.settings.goals.daily || '';
        metaSemanalInput.value = state.db.settings.goals.weekly || '';
        metaMensalInput.value = state.db.settings.goals.monthly || '';

        const renderVendedoresList = () => {
            vendedoresList.innerHTML = '';
            state.db.users.filter(u => u.role === 'vendedor').forEach(user => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded';
                li.innerHTML = `<span>${user.name}</span> <button data-id="${user.id}" class="delete-vendedor-btn p-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded-full"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>`;
                vendedoresList.appendChild(li);
            });
            lucide.createIcons();
            
            document.querySelectorAll('.delete-vendedor-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const userId = e.currentTarget.dataset.id;
                    const user = state.db.users.find(u => u.id === userId);
                    showConfirmModal(`Excluir o vendedor "${user.name}"?`, async () => {
                        const { success } = await deleteData('users', userId);
                        if (success) {
                            showToast('Vendedor excluído!');
                            state.db.users = state.db.users.filter(u => u.id !== userId);
                            renderVendedoresList();
                        }
                    });
                });
            });
        };
        renderVendedoresList();

        addVendedorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('vendedor-name');
            const passwordInput = document.getElementById('vendedor-password');
            const newUser = { name: nameInput.value.trim(), password: passwordInput.value.trim(), role: 'vendedor' };
            if (newUser.name && newUser.password) {
                const { success, id } = await saveData('users', newUser);
                if (success) {
                    showToast('Vendedor cadastrado!');
                    state.db.users.push({ id, ...newUser });
                    nameInput.value = '';
                    passwordInput.value = '';
                    renderVendedoresList();
                }
            }
        });

        saveSettingsButton.addEventListener('click', async () => {
            const newStoreName = storeNameInput.value.trim();
            const newGoals = {
                daily: parseFloat(metaDiariaInput.value) || 0,
                weekly: parseFloat(metaSemanalInput.value) || 0,
                monthly: parseFloat(metaMensalInput.value) || 0,
            };
            await Promise.all([
                saveData('settings', { name: newStoreName }, 'store'),
                saveData('settings', newGoals, 'goals')
            ]);
            state.db.settings.storeName = newStoreName;
            state.db.settings.goals = newGoals;
            document.getElementById('store-name-sidebar').textContent = newStoreName;
            showToast('Configurações salvas!');
        });
        
        zerarVendasButton.addEventListener('click', () => {
            showConfirmModal('APAGAR TODOS os registros de vendas permanentemente?', async () => {
                const deletePromises = state.db.sales.map(sale => deleteData('sales', sale.id));
                await Promise.all(deletePromises);
                state.db.sales = [];
                showToast('Todas as vendas foram zeradas!');
            });
        });

        const exportSalesToCSV = (period) => {
             const now = new Date();
             const salesToExport = state.db.sales.filter(sale => {
                if (!sale.date || !sale.date.seconds) return false;
                const saleDate = new Date(sale.date.seconds * 1000);
                if (period === 'day') {
                    return saleDate.toDateString() === now.toDateString();
                }
                if (period === 'week') {
                     const weekStart = new Date(now);
                     weekStart.setDate(now.getDate() - now.getDay());
                     weekStart.setHours(0,0,0,0);
                     return saleDate >= weekStart;
                }
                return false;
             });

            if (salesToExport.length === 0) {
                return showToast('Nenhuma venda para o período selecionado.', 'error');
            }

            let csvContent = "data:text/csv;charset=utf-8,ID,Data,Vendedor,Cliente,Valor,Pagamento\r\n";
            salesToExport.forEach(s => csvContent += `${s.id},${formatDate(s.date)},${s.seller},${s.clientName || 'N/A'},${s.total},${s.paymentMethod}\r\n`);
            
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `vendas_${period}.csv`);
            link.click();
        };

        exportDiaButton.addEventListener('click', () => exportSalesToCSV('day'));
        exportSemanaButton.addEventListener('click', () => exportSalesToCSV('week'));
    }
    
    // --- LOGIN EVENT LISTENERS ---
    document.getElementById('user-list').addEventListener('click', (e) => {
        const userButton = e.target.closest('button[data-username]');
        if (!userButton) return;
        selectedUserForLogin = userButton.dataset.username;
        document.getElementById('user-selection-view').classList.add('hidden');
        document.getElementById('password-view').classList.remove('hidden');
        document.getElementById('selected-user-info').innerHTML = `<div class="w-20 h-20 mx-auto mb-3 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center text-4xl font-bold">${selectedUserForLogin.charAt(0).toUpperCase()}</div><h3 class="text-xl font-bold">${selectedUserForLogin}</h3>`;
        document.getElementById('password').focus();
    });

    document.getElementById('back-to-users').addEventListener('click', () => {
        selectedUserForLogin = null;
        document.getElementById('login-error').textContent = '';
        renderLoginScreen();
    });

    document.getElementById('password-form').addEventListener('submit', e => {
        e.preventDefault();
        const user = state.db.users.find(u => u.name.toLowerCase() === selectedUserForLogin.toLowerCase());
        const passwordInput = document.getElementById('password');
        if (user && user.password === passwordInput.value) {
            state.loggedInUser = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            passwordInput.value = '';
            initializeAppUI();
        } else {
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = 'Senha inválida.';
            document.getElementById('password-view').classList.add('animate-shake');
            setTimeout(() => {
                document.getElementById('password-view').classList.remove('animate-shake');
                errorEl.textContent = '';
            }, 500);
        }
    });
    
    // --- GLOBAL INITIALIZATION ---
    const init = async () => {
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        document.getElementById('mobile-menu-button').addEventListener('click',()=>showMobileMenu(true));
        document.getElementById('sidebar-overlay').addEventListener('click',()=>showMobileMenu(false));
        applyTheme(localStorage.getItem('theme') || 'light');
        lucide.createIcons();
        await loadInitialData();
        renderLoginScreen();
    };
    
    init();
});
</script>