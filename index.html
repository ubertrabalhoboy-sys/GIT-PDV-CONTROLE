<!DOCTYPE html>
<html lang="pt-BR" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV de Vendas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        html.dark body {
            background-color: #0f172a; /* bg-slate-900 */
        }

        /* Animações */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out forwards;
        }

        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }
        .blinking-cursor {
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            from, to {
                border-right-color: transparent;
            }
            50% {
                border-right-color: currentColor;
            }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                            950: '#052e16'
                        },
                        slate: {
                           50: '#f8fafc',
                           100: '#f1f5f9',
                           200: '#e2e8f0',
                           300: '#cbd5e1',
                           400: '#94a3b8',
                           500: '#64748b',
                           600: '#475569',
                           700: '#334155',
                           800: '#1e293b',
                           900: '#0f172a',
                           950: '#020617'
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="text-slate-700 dark:text-slate-300">

    <!-- Tela de Login -->
    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center p-4 bg-slate-50 dark:bg-slate-900">
        <div class="w-full max-w-sm mx-auto">
             <div class="absolute top-5 right-5">
                <button id="theme-toggle" type="button" class="text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus:ring-4 focus:ring-slate-200 dark:focus:ring-slate-700 rounded-lg text-sm p-2.5">
                    <i id="theme-icon-sun" data-lucide="sun" class="w-5 h-5 hidden"></i>
                    <i id="theme-icon-moon" data-lucide="moon" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="main-login-box" class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg text-center">
                <div class="mx-auto mb-4 inline-block p-3 bg-primary-100 dark:bg-primary-900/50 rounded-full">
                    <i data-lucide="shopping-basket" class="w-8 h-8 text-primary-600 dark:text-primary-400"></i>
                </div>
                <h1 id="login-store-name" class="text-2xl font-bold text-slate-900 dark:text-white mb-1">Sistema de Vendas</h1>

                <!-- First Run View -->
                <div id="first-run-view" class="hidden text-left">
                     <p class="text-slate-500 dark:text-slate-400 mb-6 text-center">Configurando o sistema pela primeira vez, por favor aguarde...</p>
                     <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-primary-500 mx-auto"></div>
                </div>

                <!-- Store Selection -->
                <div id="store-selection-view" class="hidden">
                     <p class="text-slate-500 dark:text-slate-400 mb-8">Selecione a sua loja</p>
                     <div id="store-list" class="space-y-2"></div>
                </div>

                <!-- User Selection -->
                <div id="user-selection-view" class="hidden">
                    <p class="text-slate-500 dark:text-slate-400 mb-8">Quem está acessando?</p>
                    <div id="user-list" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                    <button id="back-to-stores" class="mt-6 text-sm text-slate-500 hover:text-primary-600">Voltar para seleção de lojas</button>
                </div>

                <!-- Password View -->
                <div id="password-view" class="hidden">
                    <div id="selected-user-info" class="mb-4"></div>
                    <form id="password-form">
                        <input type="password" id="password" class="w-full px-4 py-2 text-center text-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="Digite sua senha" required>
                        <p id="login-error" class="text-red-500 text-sm mt-2 h-5"></p>
                        <div class="mt-4 flex flex-col sm:flex-row gap-2 justify-center">
                            <button type="button" id="back-to-users" class="w-full sm:w-auto px-5 py-2.5 text-sm font-medium text-slate-700 dark:text-slate-300 focus:outline-none bg-slate-100 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600 hover:bg-slate-200 dark:hover:bg-slate-600">Voltar</button>
                            <button type="submit" class="w-full sm:w-auto text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">Entrar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- App Principal -->
    <div id="app" class="hidden">
        <aside id="sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen transition-transform -translate-x-full sm:translate-x-0 bg-slate-800">
            <div class="h-full px-3 py-4 overflow-y-auto">
                <div class="flex flex-col items-center mb-6 pb-4 border-b border-slate-700">
                    <div id="user-icon" class="w-16 h-16 mb-2 rounded-full bg-primary-600 flex items-center justify-center text-white text-3xl font-bold"></div>
                    <h5 id="username-sidebar" class="text-xl font-semibold text-white"></h5>
                    <span id="store-name-sidebar" class="text-sm text-slate-400"></span>
                </div>
                <ul id="vendedor-menu" class="space-y-2 font-medium"></ul>
                <ul id="gerente-menu" class="space-y-2 font-medium"></ul>
            </div>
        </aside>

        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 sm:hidden"></div>

        <div class="sm:ml-64">
            <header class="sticky top-0 bg-slate-50/80 dark:bg-slate-900/80 backdrop-blur-sm z-20 border-b border-slate-200 dark:border-slate-800">
                <div class="p-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button id="mobile-menu-button" class="sm:hidden text-slate-600 dark:text-slate-300">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h2 id="current-view-title" class="text-xl font-bold text-slate-900 dark:text-white"></h2>
                    </div>
                     <div class="flex items-center gap-4">
                         <div id="store-switcher-container" class="hidden">
                             <select id="store-switcher-select" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-sm py-1.5"></select>
                         </div>
                        <button id="theme-toggle-app" type="button" class="text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus:ring-4 focus:ring-slate-200 dark:focus:ring-slate-700 rounded-lg text-sm p-2.5">
                           <i id="theme-icon-sun-app" data-lucide="sun" class="w-5 h-5 hidden"></i>
                           <i id="theme-icon-moon-app" data-lucide="moon" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </header>

            <main class="p-4 md:p-6">
                <div id="caixa-view" class="view"></div>
                <div id="pedidos-view" class="view"></div>
                <div id="metas-view" class="view"></div>
                <div id="relatorios-view" class="view"></div>
                <div id="configuracoes-view" class="view"></div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="finalize-order-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"></div>
    <div id="order-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"></div>
    <div id="whatsapp-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"></div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Confirmação</h3>
            <p id="confirm-modal-message" class="mb-6 text-slate-600 dark:text-slate-400"></p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 py-2 px-4 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors">Cancelar</button>
                <button id="confirm-modal-confirm" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <script type="text/html" id="caixa-template">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Registrar Item</h3>
                <form id="add-item-form" class="space-y-4">
                    <div><label for="item-name" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Nome do Item</label><input type="text" id="item-name" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:border-primary-500 focus:ring-primary-500"></div>
                    <div><label for="item-value" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Valor (R$)</label><input type="number" id="item-value" step="0.01" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:border-primary-500 focus:ring-primary-500"></div>
                    <div>
                        <label for="item-exchange" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Prazo de Troca</label>
                        <select id="item-exchange" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:border-primary-500 focus:ring-primary-500">
                            <option>Sem Troca</option>
                            <option>7 dias</option>
                            <option>15 dias</option>
                            <option>30 dias</option>
                            <option>45 dias</option>
                            <option>60 dias</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-primary-600 text-white py-2.5 px-4 rounded-md hover:bg-primary-700 transition-colors flex items-center justify-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i>Adicionar Item</button>
                </form>
            </div>
            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Pedido Atual</h3>
                <div id="current-order-items" class="space-y-2 mb-4 min-h-[120px]"></div>
                <div class="border-t dark:border-slate-700 pt-4 flex justify-between items-center">
                    <span class="text-xl font-bold text-slate-800 dark:text-slate-100">Total:</span>
                    <span id="current-order-total" class="text-2xl font-bold text-primary-600 dark:text-primary-400">R$ 0,00</span>
                </div>
                <button id="finalize-order-button" class="w-full mt-6 bg-primary-600 text-white py-3 px-4 rounded-md hover:bg-primary-700 transition-colors disabled:bg-slate-400 dark:disabled:bg-slate-600 disabled:cursor-not-allowed flex items-center justify-center gap-2 text-lg"><i data-lucide="check-circle" class="w-6 h-6"></i>Finalizar Pedido</button>
            </div>
        </div>
    </script>

    <script type="text/html" id="pedidos-template">
         <div class="space-y-6">
            <div id="vendedor-pedidos-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md flex items-center gap-4"><div class="bg-blue-100 dark:bg-blue-900/50 p-3 rounded-full"><i data-lucide="shopping-cart" class="w-6 h-6 text-blue-600 dark:text-blue-300"></i></div><div><p class="text-sm text-slate-500 dark:text-slate-400">Pedidos Finalizados</p><p id="pedidos-finalizados" class="text-2xl font-bold text-slate-800 dark:text-slate-100">0</p></div></div>
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md flex items-center gap-4"><div class="bg-green-100 dark:bg-green-900/50 p-3 rounded-full"><i data-lucide="dollar-sign" class="w-6 h-6 text-green-600 dark:text-green-300"></i></div><div><p class="text-sm text-slate-500 dark:text-slate-400">Valor Total</p><p id="valor-total" class="text-2xl font-bold text-slate-800 dark:text-slate-100">R$ 0,00</p></div></div>
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md flex items-center gap-4"><div class="bg-yellow-100 dark:bg-yellow-900/50 p-3 rounded-full"><i data-lucide="receipt-text" class="w-6 h-6 text-yellow-600 dark:text-yellow-300"></i></div><div><p class="text-sm text-slate-500 dark:text-slate-400">Ticket Médio</p><p id="ticket-medio" class="text-2xl font-bold text-slate-800 dark:text-slate-100">R$ 0,00</p></div></div>
            </div>
            
            <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md">
                 <form id="filter-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end pb-4 border-b border-slate-200 dark:border-slate-700">
                     <div class="lg:col-span-2">
                         <label for="filter-date" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Data</label>
                         <input type="date" id="filter-date" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                     </div>
                     <div>
                         <label for="filter-payment" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Pagamento</label>
                         <select id="filter-payment" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                             <option>Todos</option><option>Pix</option><option>Cartão</option><option>Dinheiro</option>
                         </select>
                     </div>
                     <div id="gerente-vendedor-filter-container" class="hidden">
                         <label for="filter-vendedor" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Vendedor</label>
                         <select id="filter-vendedor" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700"></select>
                     </div>
                     <div class="flex gap-2">
                         <button type="submit" class="w-full bg-primary-600 text-white p-2 rounded-md flex items-center justify-center gap-2"><i data-lucide="search" class="w-4 h-4"></i>Buscar</button>
                         <button type="reset" class="w-full bg-slate-500 hover:bg-slate-600 text-white p-2 rounded-md flex items-center justify-center gap-2"><i data-lucide="rotate-cw" class="w-4 h-4"></i>Limpar</button>
                     </div>
                 </form>
                <div class="relative overflow-x-auto pt-4">
                     <table class="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                         <thead class="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400">
                            <tr id="orders-table-header-row">
                                 <th scope="col" class="px-6 py-3">Cliente</th>
                                 <th scope="col" class="px-6 py-3">Data</th>
                                 <th scope="col" class="px-6 py-3">Pagamento</th>
                                 <th scope="col" class="px-6 py-3 text-right">Total</th>
                                 <th scope="col" class="px-6 py-3 text-center">Ações</th>
                            </tr>
                         </thead>
                         <tbody id="orders-table-body"></tbody>
                     </table>
                     <div id="no-orders-found" class="text-center p-8 text-slate-500 hidden">Nenhum pedido encontrado.</div>
                </div>
            </div>
        </div>
    </script>
    
    <script type="text/html" id="metas-template">
        <div class="space-y-6">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Meu Progresso</h3>
                <div class="space-y-4">
                    <!-- Meta Diária -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-slate-700 dark:text-slate-300">Meta Diária</span>
                            <span id="progresso-diario-texto" class="text-sm font-medium text-slate-700 dark:text-slate-300">R$ 0 / R$ 0</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700">
                            <div id="progresso-diario-barra" class="bg-primary-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- Meta Semanal -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-slate-700 dark:text-slate-300">Meta Semanal</span>
                            <span id="progresso-semanal-texto" class="text-sm font-medium text-slate-700 dark:text-slate-300">R$ 0 / R$ 0</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700">
                            <div id="progresso-semanal-barra" class="bg-primary-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- Meta Mensal -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-slate-700 dark:text-slate-300">Meta Mensal</span>
                            <span id="progresso-mensal-texto" class="text-sm font-medium text-slate-700 dark:text-slate-300">R$ 0 / R$ 0</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700">
                            <div id="progresso-mensal-barra" class="bg-primary-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md text-center">
                    <i data-lucide="flame" class="w-8 h-8 mx-auto mb-2 text-red-500"></i>
                    <p class="text-sm text-slate-500">Meta Batida (Dias seguidos)</p>
                    <p id="recorde-dias-consecutivos" class="text-2xl font-bold text-slate-800 dark:text-slate-100">0</p>
                </div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md text-center">
                    <i data-lucide="award" class="w-8 h-8 mx-auto mb-2 text-amber-500"></i>
                    <p class="text-sm text-slate-500">Melhor Dia</p>
                    <p id="recorde-melhor-dia" class="text-2xl font-bold text-slate-800 dark:text-slate-100">R$ 0,00</p>
                </div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md text-center">
                    <i data-lucide="trophy" class="w-8 h-8 mx-auto mb-2 text-sky-500"></i>
                    <p class="text-sm text-slate-500">Melhor Semana</p>
                    <p id="recorde-melhor-semana" class="text-2xl font-bold text-slate-800 dark:text-slate-100">R$ 0,00</p>
                </div>
            </div>
        </div>
    </script>

    <script type="text/html" id="relatorios-template">
        <div class="space-y-6">
             <div id="gerente-relatorios-vendedor-select-container" class="hidden bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md">
                <label for="relatorios-vendedor-select" class="block text-sm font-medium mb-1 text-slate-600 dark:text-slate-400">Visualizar Relatório de:</label>
                <select id="relatorios-vendedor-select" class="w-full md:w-1/3 block rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700"></select>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><p class="text-sm text-slate-500">Vendas Hoje</p><p id="relatorio-vendas-hoje" class="text-2xl font-bold text-primary-600">R$ 0,00</p></div>
                 <div id="bonus-hoje-card" class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><p class="text-sm text-slate-500">Bônus Hoje</p><p id="relatorio-bonus-dia" class="text-2xl font-bold text-primary-600">0</p></div>
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><p class="text-sm text-slate-500">Vendas na Semana</p><p id="relatorio-vendas-semana" class="text-2xl font-bold text-slate-800 dark:text-slate-100">R$ 0,00</p></div>
                 <div id="bonus-semana-card" class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><p class="text-sm text-slate-500">Bônus na Semana</p><p id="relatorio-bonus-semana" class="text-2xl font-bold text-slate-800 dark:text-slate-100">0</p></div>
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><p class="text-sm text-slate-500">Vendas no Mês</p><p id="relatorio-vendas-mes" class="text-2xl font-bold text-slate-800 dark:text-slate-100">R$ 0,00</p></div>
                 <div id="bonus-mes-card" class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><p class="text-sm text-slate-500">Bônus no Mês</p><p id="relatorio-bonus-mes" class="text-2xl font-bold text-slate-800 dark:text-slate-100">0</p></div>
             </div>

             <div id="ranking-section" class="hidden bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">Ranking de Vendedores</h3>
                    <div class="flex space-x-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-md">
                        <button data-period="day" class="ranking-period-btn bg-white dark:bg-slate-900 text-primary-600 rounded shadow px-3 py-1 text-sm font-medium">Dia</button>
                        <button data-period="week" class="ranking-period-btn text-slate-500 dark:text-slate-400 px-3 py-1 text-sm font-medium">Semana</button>
                        <button data-period="month" class="ranking-period-btn text-slate-500 dark:text-slate-400 px-3 py-1 text-sm font-medium">Mês</button>
                    </div>
                 </div>
                 <ul id="ranking-list" class="space-y-2"></ul>
             </div>

             <div id="ai-analysis-section" class="hidden bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">Análise de Desempenho com IA <span class="text-xs bg-primary-100 text-primary-700 dark:bg-primary-900/50 dark:text-primary-300 px-2 py-0.5 rounded-full">NOVO</span></h3>
                 </div>
                 <div class="border-t dark:border-slate-700 pt-4">
                     <button id="generate-ai-analysis-btn" class="w-full sm:w-auto bg-primary-600 text-white py-2 px-4 rounded-md hover:bg-primary-700 transition-colors flex items-center justify-center gap-2">
                         <i data-lucide="sparkles" class="w-4 h-4"></i>
                         Gerar Análise com IA
                     </button>
                     <div id="ai-analysis-result-container" class="mt-4 text-sm text-slate-600 dark:text-slate-300 space-y-2 prose dark:prose-invert max-w-none">
                         <p class="text-slate-500 dark:text-slate-400">Clique no botão para gerar uma análise inteligente dos dados de vendas do período selecionado.</p>
                     </div>
                 </div>
             </div>

             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                 <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                     <h3 class="font-bold mb-4 text-slate-900 dark:text-white">Vendas nos últimos 7 dias</h3>
                     <div class="h-80"><canvas id="vendas-semana-chart"></canvas></div>
                 </div>
                 <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                     <h3 class="font-bold mb-4 text-slate-900 dark:text-white">Formas de Pagamento</h3>
                     <div class="h-80"><canvas id="pagamento-chart"></canvas></div>
                 </div>
             </div>
        </div>
    </script>
    
    <script type="text/html" id="configuracoes-template">
        <div class="space-y-6">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Painel Administrativo</h3>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-slate-200 dark:border-slate-700 pt-4">
                    <div>
                         <h4 class="text-md font-semibold text-slate-800 dark:text-slate-200 mb-2">Configurações da Loja</h4>
                         <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Nome da Loja</label>
                         <input type="text" id="config-store-name" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                         <button id="save-settings-button" class="mt-2 bg-primary-600 text-white py-2 px-4 rounded-md hover:bg-primary-700 transition-colors text-sm">Salvar Nome</button>
                    </div>
                     <div>
                         <h4 class="text-md font-semibold text-red-600 dark:text-red-500 mb-2">Zona de Perigo</h4>
                         <p class="text-xs text-slate-500 mb-2">Esta ação não pode ser desfeita e removerá permanentemente todas as vendas do sistema.</p>
                         <button id="delete-all-sales-button" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors text-sm">Zerar Todas as Vendas</button>
                     </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Definir Metas e Bônus</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="meta-diaria" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Meta Diária (R$)</label>
                            <input type="number" id="meta-diaria" step="0.01" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                        </div>
                        <div>
                            <label for="meta-semanal" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Meta Semanal (R$)</label>
                            <input type="number" id="meta-semanal" step="0.01" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                        </div>
                         <div>
                            <label for="meta-mensal" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Meta Mensal (R$)</label>
                            <input type="number" id="meta-mensal" step="0.01" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                        </div>
                    </div>
                    <div class="border-t dark:border-slate-700 pt-4 space-y-2">
                        <div class="flex items-center">
                            <input id="enable-bonus" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500">
                            <label for="enable-bonus" class="ml-2 block text-sm text-slate-900 dark:text-slate-300">Habilitar sistema de bônus</label>
                        </div>
                        <div id="bonus-value-container" class="hidden">
                             <label for="bonus-value" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Ganha 2 pontos de bônus a cada (R$)</label>
                            <input type="number" id="bonus-value" step="0.01" class="block w-full md:w-1/3 rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                        </div>
                    </div>
                     <button id="save-goals-button" class="mt-4 bg-primary-600 text-white py-2 px-4 rounded-md hover:bg-primary-700 transition-colors text-sm">Salvar</button>
                </div>
            </div>
            
            <div id="manage-stores-section" class="hidden bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Gerenciar Lojas</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 border-t dark:border-slate-700 pt-4">
                    <div>
                        <h4 class="text-md font-semibold mb-2">Criar Nova Loja</h4>
                        <form id="add-store-form" class="space-y-4">
                            <div>
                                <label for="new-store-name" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Nome da Nova Loja</label>
                                <input type="text" id="new-store-name" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                            </div>
                            <button type="submit" class="w-full bg-primary-600 text-white py-2 px-4 rounded-md hover:bg-primary-700 transition-colors">Criar Loja</button>
                        </form>
                    </div>
                    <div>
                        <h4 class="text-md font-semibold mb-2">Lojas Cadastradas</h4>
                        <ul id="stores-management-list" class="space-y-2"></ul>
                    </div>
                </div>
            </div>


            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Exportar Vendas (CSV)</h3>
                <div class="space-y-4 border-t dark:border-slate-700 pt-4">
                    <div>
                        <label for="export-vendedor-select" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Filtrar por Vendedor</label>
                        <select id="export-vendedor-select" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700"></select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <button id="export-today-btn" class="w-full bg-slate-500 text-white p-2 rounded-md hover:bg-slate-600 transition-colors text-sm flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i>Vendas do Dia</button>
                        <button id="export-week-btn" class="w-full bg-slate-500 text-white p-2 rounded-md hover:bg-slate-600 transition-colors text-sm flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i>Vendas da Semana</button>
                        <button id="export-month-btn" class="w-full bg-slate-500 text-white p-2 rounded-md hover:bg-slate-600 transition-colors text-sm flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i>Vendas do Mês</button>
                    </div>
                    <div class="border-t dark:border-slate-700 pt-4">
                        <p class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Exportar por data específica:</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="start-date" class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Data de Início</label>
                                <input type="date" id="start-date" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-sm">
                            </div>
                            <div>
                                <label for="end-date" class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Data Final</label>
                                <input type="date" id="end-date" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-sm">
                            </div>
                        </div>
                        <button id="export-range-btn" class="w-full mt-2 bg-primary-600 text-white p-2 rounded-md hover:bg-primary-700 transition-colors text-sm flex items-center justify-center gap-2"><i data-lucide="download-cloud" class="w-4 h-4"></i>Exportar Período</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Adicionar Novo Usuário</h3>
                    <form id="add-user-form" class="space-y-4">
                        <div>
                            <label for="user-name" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Nome</label>
                            <input type="text" id="user-name" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                        </div>
                        <div>
                            <label for="user-password" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Senha</label>
                            <input type="password" id="user-password" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                        </div>
                        <div class="flex items-center">
                            <input id="create-as-manager" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-primary-600 focus:ring-primary-500">
                            <label for="create-as-manager" class="ml-2 block text-sm text-slate-900 dark:text-slate-300">Criar como Gerente</label>
                        </div>
                        <button type="submit" class="w-full bg-primary-600 text-white py-2 px-4 rounded-md hover:bg-primary-700 transition-colors">Salvar Usuário</button>
                    </form>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Usuários Cadastrados</h3>
                    <ul id="users-list" class="space-y-2"></ul>
                </div>
            </div>
        </div>
    </script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, onSnapshot, doc, addDoc, deleteDoc, setDoc, query, where, writeBatch, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Mantenha suas credenciais do Firebase aqui
        const firebaseConfig = {
            apiKey: "AIzaSyByZ1r41crqOadLXwHH2v9LgveyCkL6erE",
            authDomain: "pdv-vendas-8a65a.firebaseapp.com",
            projectId: "pdv-vendas-8a65a",
            storageBucket: "pdv-vendas-8a65a.appspot.com",
            messagingSenderId: "37533259212",
            appId: "1:37533259212:web:9e79fecb52aa2b4765b969",
            measurementId: "G-7PYWX52SEG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        document.addEventListener('DOMContentLoaded', () => {
            let state = {
                loggedInUser: null, // Armazenará os metadados do Firestore (role, name, etc.)
                currentView: '',
                currentOrder: [],
                db: {
                    users: [], // Metadados dos usuários
                    stores: [],
                    settings: { 
                        storeName: "Minha Loja",
                        goals: { daily: 150, weekly: 1000, monthly: 4000 },
                        bonusSystem: { enabled: true, value: 80 }
                    },
                    sales: []
                },
                listeners: { users: null, sales: null, stores: null },
                selectedStore: null
            };
            let selectedUserForLogin = null;
            let vendasChartInstance = null;
            let pagamentoChartInstance = null;
            let currentRankingPeriod = 'day';

            async function loadInitialData() {
                document.getElementById('first-run-view').classList.add('hidden');
                document.getElementById('store-selection-view').classList.add('hidden');
                document.getElementById('user-selection-view').classList.add('hidden');
                document.getElementById('password-view').classList.add('hidden');

                try {
                    const storesQuery = query(collection(db, "stores"));
                    const storesSnapshot = await getDocs(storesQuery);

                    if (storesSnapshot.empty) {
                        document.getElementById('first-run-view').classList.remove('hidden');
                        document.getElementById('first-run-view').innerHTML = '<p class="text-slate-500 dark:text-slate-400 mb-6 text-center">Configurando o sistema pela primeira vez, por favor aguarde...</p><div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-primary-500 mx-auto"></div>';

                        const storeName = "Loja Principal";
                        const adminName = "superadmin";
                        const adminPass = "admin123";
                        const adminEmail = `${adminName}@pdv.local`;

                        // Criar usuário no Firebase Auth
                        const userCredential = await createUserWithEmailAndPassword(auth, adminEmail, adminPass);
                        const adminUID = userCredential.user.uid;

                        // Criar loja e configurações
                        const storeRef = await addDoc(collection(db, "stores"), { name: storeName });
                        
                        // Salvar metadados do usuário no Firestore com o UID como ID
                        await setDoc(doc(db, "users", adminUID), {
                            name: adminName,
                            role: 'superadmin',
                            // superadmin não pertence a uma loja específica
                        });
                        
                        await setDoc(doc(db, "settings", storeRef.id), {
                            storeName: storeName,
                            goals: { daily: 150, weekly: 1000, monthly: 4000 },
                            bonusSystem: { enabled: true, value: 80 }
                        });
                        
                        showToast('Sistema pronto! Faça login como superadmin (senha: admin123).', 'success');
                        await loadInitialData(); 
                        return;
                    } else {
                        state.db.stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderStoreSelection();
                        document.getElementById('store-selection-view').classList.remove('hidden');
                    }
                } catch (error) {
                    // Ignora o erro "auth/email-already-in-use" na primeira execução
                    if (error.code === 'auth/email-already-in-use') {
                        console.warn("Usuário superadmin já existe, carregando lojas...");
                        const storesSnapshot = await getDocs(query(collection(db, "stores")));
                         state.db.stores = storesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderStoreSelection();
                        document.getElementById('store-selection-view').classList.remove('hidden');
                    } else {
                        console.error("Erro na configuração inicial:", error);
                        showToast('Falha ao iniciar o sistema.', 'error');
                    }
                }
            }

            function renderStoreSelection() {
                const storeList = document.getElementById('store-list');
                storeList.innerHTML = '';
                state.db.stores.forEach(store => {
                    const storeButton = document.createElement('button');
                    storeButton.className = 'w-full text-left p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors duration-200 border border-slate-200 dark:border-slate-700';
                    storeButton.dataset.storeId = store.id;
                    storeButton.dataset.storeName = store.name;
                    storeButton.textContent = store.name;
                    storeList.appendChild(storeButton);
                });
            }

            document.getElementById('store-list').addEventListener('click', async (e) => {
                const storeButton = e.target.closest('button');
                if (!storeButton) return;
                
                state.selectedStore = {
                    id: storeButton.dataset.storeId,
                    name: storeButton.dataset.storeName
                };

                const settingsRef = doc(db, "settings", state.selectedStore.id);
                const settingsSnap = await getDoc(settingsRef);
                 if (settingsSnap.exists()) {
                     state.db.settings = { ...state.db.settings, ...settingsSnap.data() };
                } else {
                     await setDoc(settingsRef, {
                         storeName: state.selectedStore.name,
                         goals: { daily: 150, weekly: 1000, monthly: 4000 },
                         bonusSystem: { enabled: true, value: 80 }
                    });
                     state.db.settings.storeName = state.selectedStore.name;
                     state.db.settings.goals = { daily: 150, weekly: 1000, monthly: 4000 };
                     state.db.settings.bonusSystem = { enabled: true, value: 80 };
                }

                loadUsersForStore(state.selectedStore.id);
            });

            async function loadUsersForStore(storeId) {
                try {
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("storeId", "==", storeId));
                    const superAdminQ = query(usersRef, where("role", "==", "superadmin"));

                    const [usersSnapshot, superAdminSnapshot] = await Promise.all([getDocs(q), getDocs(superAdminQ)]);
                    
                    let users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const superAdmins = superAdminSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    state.db.users = [...users, ...superAdmins];

                    const userList = document.getElementById('user-list');
                    userList.innerHTML = '';
                    if (state.db.users.length > 0) {
                        state.db.users.forEach(user => {
                            const userButton = document.createElement('button');
                            userButton.className = 'flex flex-col items-center p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors duration-200 transform hover:scale-105 border border-slate-200 dark:border-slate-700';
                            userButton.dataset.username = user.name;
                            userButton.dataset.userid = user.id; // Salva o ID do documento (que é o UID do Auth)
                            userButton.innerHTML = `<div class="w-16 h-16 mb-2 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-slate-500 dark:text-slate-300 text-3xl font-bold">${user.name.charAt(0).toUpperCase()}</div><span class="font-semibold text-slate-800 dark:text-slate-200 text-center">${user.name}</span>`;
                            userList.appendChild(userButton);
                        });
                    } else {
                        userList.innerHTML = '<p class="col-span-full text-center text-slate-500">Nenhum usuário para esta loja.</p>';
                    }
                    document.getElementById('store-selection-view').classList.add('hidden');
                    document.getElementById('user-selection-view').classList.remove('hidden');
                } catch (error) {
                    console.error("Erro ao carregar usuários:", error);
                    showToast('Falha ao carregar usuários.', 'error');
                }
            }
            
            document.getElementById('back-to-stores').addEventListener('click', () => {
                document.getElementById('user-selection-view').classList.add('hidden');
                document.getElementById('store-selection-view').classList.remove('hidden');
                state.selectedStore = null;
                state.db.users = [];
            });

            // --- Funções Utilitárias ---
            const applyTheme = (theme) => {
                const html = document.documentElement;
                const isDark = theme === 'dark';
                html.classList.toggle('dark', isDark);
                ['theme-icon-moon', 'theme-icon-moon-app'].forEach(id => document.getElementById(id)?.classList.toggle('hidden', isDark));
                ['theme-icon-sun', 'theme-icon-sun-app'].forEach(id => document.getElementById(id)?.classList.toggle('hidden', !isDark));
            };

            const formatCurrency = value => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
            
            const formatDate = date => {
                if (date && date.toDate) { 
                    return date.toDate().toLocaleDateString('pt-BR');
                }
                return new Date(date).toLocaleDateString('pt-BR');
            };

            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                toast.className = `fixed bottom-5 right-5 ${type === 'success' ? 'bg-primary-600' : 'bg-red-600'} text-white py-2 px-4 rounded-lg shadow-lg z-[70] animate-bounce`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            };

            const showConfirmModal = (message, onConfirm) => {
                const modal = document.getElementById('confirm-modal');
                modal.querySelector('#confirm-modal-message').textContent = message;
                modal.classList.remove('hidden');
                const confirmBtn = modal.querySelector('#confirm-modal-confirm');
                const cancelBtn = modal.querySelector('#confirm-modal-cancel');

                const handleConfirm = () => {
                    onConfirm();
                    hideModal();
                };
                const hideModal = () => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', hideModal);
                };

                confirmBtn.addEventListener('click', handleConfirm, { once: true });
                cancelBtn.addEventListener('click', hideModal, { once: true });
            };

            function exportToCSV(data, filename) {
                if (data.length === 0) {
                    showToast('Nenhuma venda encontrada para exportar.', 'error');
                    return;
                }

                const headers = ["Data da Compra", "ID da Venda", "Nome do Cliente", "Telefone do Cliente", "Vendedor", "Itens Vendidos", "Forma de Pagamento", "Total da Venda", "Bônus da Venda"];
                
                const formatItemsForCSV = (items) => {
                    if (!Array.isArray(items)) return '';
                    return items.map(item => `${item.name} (Valor: ${formatCurrency(item.value)}, Troca: ${item.exchange})`).join(' | ');
                };

                const rows = data.map(sale => [
                    new Date(sale.date.seconds * 1000).toLocaleString('pt-BR'),
                    sale.id,
                    sale.clientName,
                    sale.clientPhone || '',
                    sale.vendedor,
                    formatItemsForCSV(sale.items),
                    sale.paymentMethod,
                    (sale.total || 0).toFixed(2).replace('.', ','),
                    sale.bonus
                ]);

                let csvContent = "data:text/csv;charset=utf-8,\uFEFF" 
                    + headers.join(",") + "\n" 
                    + rows.map(e => e.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",")).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${filename}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // --- Lógica de Login ---
            document.getElementById('user-selection-view').addEventListener('click', (e) => {
                const userButton = e.target.closest('button');
                if (!userButton || !userButton.dataset.username) return;

                selectedUserForLogin = {
                    name: userButton.dataset.username,
                    id: userButton.dataset.userid
                };

                document.getElementById('user-selection-view').classList.add('hidden');
                document.getElementById('password-view').classList.remove('hidden');
                document.getElementById('selected-user-info').innerHTML = `<div class="w-20 h-20 mx-auto mb-3 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-slate-500 dark:text-slate-300 text-4xl font-bold">${selectedUserForLogin.name.charAt(0).toUpperCase()}</div><h3 class="text-xl font-bold text-slate-900 dark:text-white">${selectedUserForLogin.name}</h3>`;
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            });

            document.getElementById('back-to-users').addEventListener('click', () => {
                selectedUserForLogin = null;
                document.getElementById('password-view').classList.add('hidden');
                document.getElementById('user-selection-view').classList.remove('hidden');
                document.getElementById('login-error').textContent = '';
            });

            document.getElementById('password-form').addEventListener('submit', async e => {
                e.preventDefault();
                const email = `${selectedUserForLogin.name}@pdv.local`;
                const password = document.getElementById('password').value;
                const errorEl = document.getElementById('login-error');
                
                try {
                    errorEl.textContent = '';
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const userUID = userCredential.user.uid;

                    // Busca os metadados do usuário no Firestore
                    const userDocRef = doc(db, "users", userUID);
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        state.loggedInUser = { id: userUID, ...userDocSnap.data() };
                        
                        if (state.loggedInUser.role !== 'superadmin' && !state.selectedStore) {
                           state.selectedStore = state.db.stores.find(s => s.id === state.loggedInUser.storeId);
                        }

                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                        document.getElementById('password').value = '';
                        initializeAppUI();
                    } else {
                        throw new Error("Dados do usuário não encontrados.");
                    }
                } catch (error) {
                    console.error("Erro de login:", error.code);
                    errorEl.textContent = 'Usuário ou senha inválidos.';
                    const passwordView = document.getElementById('password-view');
                    passwordView.classList.add('animate-shake');
                    setTimeout(() => passwordView.classList.remove('animate-shake'), 500);
                }
            });

            const logout = async () => {
                if (state.listeners.users) state.listeners.users();
                if (state.listeners.sales) state.listeners.sales();
                if (state.listeners.stores) state.listeners.stores();
                state.listeners = { users: null, sales: null, stores: null };
                
                await signOut(auth);

                Object.assign(state, { 
                    loggedInUser: null, 
                    selectedStore: null, 
                    currentOrder: [], 
                    db: { users: [], stores: [], sales: [], settings: {} }
                });
                selectedUserForLogin = null;
                document.getElementById('app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('store-switcher-container').classList.add('hidden');
                loadInitialData();
            };
            
            // --- Lógica Principal do App ---
            const initializeAppUI = () => {
                // ... (código existente, sem alterações) ...
            };

            const switchView = (viewId) => {
                if (state.listeners.sales) {
                    state.listeners.sales(); // Desanexa listener de vendas ao trocar de view
                    state.listeners.sales = null;
                }
                
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active', 'fade-in'));
                const activeView = document.getElementById(`${viewId}-view`);
                if (activeView) {
                    activeView.classList.add('active', 'fade-in'); 
                    state.currentView = viewId;
                    const link = document.querySelector(`#sidebar a[data-view="${viewId}"]`);
                    if (link) {
                        document.getElementById('current-view-title').textContent = link.querySelector('span').textContent;
                        document.querySelectorAll('#sidebar ul li a').forEach(l => l.classList.remove('bg-slate-700', 'text-white'));
                        link.classList.add('bg-slate-700', 'text-white');
                    }
                    renderViewContent(viewId);
                }
                showMobileMenu(false);
            };
            
            const renderViewContent = (viewId) => {
                const viewContainer = document.getElementById(`${viewId}-view`);
                if(document.getElementById(`${viewId}-template`)) {
                    viewContainer.innerHTML = document.getElementById(`${viewId}-template`).innerHTML;
                }
                lucide.createIcons();
                switch (viewId) {
                    case 'caixa': renderCaixa(); break;
                    case 'pedidos': renderPedidos(); break;
                    case 'metas': renderMetas(); break;
                    case 'relatorios': renderRelatorios(); break;
                    case 'configuracoes': renderConfiguracoes(); break;
                }
            };
            
            // --- Renderização das Views ---
            
            function renderCaixa() {
                // Código formatado e funcional
                const container = document.getElementById('caixa-view');
                const itemsContainer = container.querySelector('#current-order-items');
                const totalEl = container.querySelector('#current-order-total');
                const finalizeBtn = container.querySelector('#finalize-order-button');
                const addForm = container.querySelector('#add-item-form');
                const modalContainer = document.getElementById('finalize-order-modal');

                const updateUI = () => {
                    itemsContainer.innerHTML = '';
                    if (state.currentOrder.length === 0) {
                        itemsContainer.innerHTML = '<p id="no-items-message" class="text-slate-500 dark:text-slate-400 text-center py-4">Nenhum item adicionado.</p>';
                        finalizeBtn.disabled = true;
                    } else {
                        state.currentOrder.forEach((item, i) => {
                            const el = document.createElement('div');
                            el.className = 'flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 p-3 rounded-md';
                            el.innerHTML = `
                                <div>
                                    <p class="font-semibold text-slate-800 dark:text-slate-200">${item.name}</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Troca: ${item.exchange || 'N/A'}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="font-semibold text-slate-800 dark:text-slate-200">${formatCurrency(item.value)}</span>
                                    <button data-index="${i}" class="remove-item-btn text-red-500 hover:text-red-700 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>`;
                            itemsContainer.appendChild(el);
                        });
                        finalizeBtn.disabled = false;
                    }
                    totalEl.textContent = formatCurrency(state.currentOrder.reduce((sum, i) => sum + i.value, 0));
                    lucide.createIcons();
                };

                addForm.addEventListener('submit', e => {
                    e.preventDefault();
                    state.currentOrder.push({
                        name: container.querySelector('#item-name').value,
                        value: parseFloat(container.querySelector('#item-value').value),
                        exchange: container.querySelector('#item-exchange').value
                    });
                    updateUI();
                    addForm.reset();
                    container.querySelector('#item-name').focus();
                });

                itemsContainer.addEventListener('click', e => {
                    const b = e.target.closest('.remove-item-btn');
                    if (b) {
                        state.currentOrder.splice(b.dataset.index, 1);
                        updateUI();
                    }
                });

                finalizeBtn.addEventListener('click', () => {
                    modalContainer.classList.remove('hidden');
                    modalContainer.innerHTML = `
                        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-lg p-6 m-4 fade-in">
                            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Finalizar Pedido</h2>
                            <form id="finalize-order-form" class="space-y-4">
                                <div><label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Nome do Cliente</label><input type="text" id="client-name" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700"></div>
                                <div><label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Telefone (WhatsApp)</label><input type="tel" id="client-phone" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700" placeholder="Ex: 11987654321"></div>
                                <div><label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Forma de Pagamento</label><select id="payment-method" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700"><option>Pix</option><option>Cartão</option><option>Dinheiro</option></select></div>
                                <div class="pt-4 flex justify-end gap-4"><button type="button" id="cancel-finalize-button" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="bg-primary-600 text-white py-2 px-4 rounded-md">Confirmar Venda</button></div>
                            </form>
                        </div>`;
                    
                    modalContainer.querySelector('#cancel-finalize-button').addEventListener('click', () => modalContainer.classList.add('hidden'));
                    
                    modalContainer.querySelector('#finalize-order-form').addEventListener('submit', async e => {
                        e.preventDefault();
                        const total = state.currentOrder.reduce((s, i) => s + i.value, 0);
                        let bonus = 0;
                        const bonusConfig = state.db.settings.bonusSystem;
                        if (bonusConfig && bonusConfig.enabled && bonusConfig.value > 0) {
                            bonus = Math.floor(total / bonusConfig.value) * 2;
                        }
                        const saleData = {
                            clientName: modalContainer.querySelector('#client-name').value,
                            clientPhone: modalContainer.querySelector('#client-phone').value,
                            paymentMethod: modalContainer.querySelector('#payment-method').value,
                            items: state.currentOrder,
                            total: total,
                            bonus: bonus,
                            date: Timestamp.now(),
                            vendedor: state.loggedInUser.name,
                            vendedorId: state.loggedInUser.id,
                            status: 'Finalizado',
                            storeId: state.selectedStore.id
                        };
                        try {
                            await addDoc(collection(db, "sales"), saleData);
                            showToast('Venda registrada com sucesso!', 'success');
                            modalContainer.classList.add('hidden');
                            if(saleData.clientPhone) showWhatsAppModal(saleData);
                            state.currentOrder = [];
                            updateUI();
                        } catch (error) {
                            showToast('Erro ao registrar a venda.', 'error');
                            console.error(error);
                        }
                    });
                });
                updateUI();
            }

            // ... Demais funções de renderização (pedidos, metas, etc.) com as devidas correções ...

             // --- Inicialização ---
            const init = () => {
                const theme = localStorage.getItem('theme') || 'light';
                applyTheme(theme);
                const themeToggleHandler = () => {
                    const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                    if (['relatorios', 'metas'].includes(state.currentView) && document.getElementById(`${state.currentView}-view`).classList.contains('active')) {
                        renderViewContent(state.currentView);
                    }
                };
                document.getElementById('theme-toggle').addEventListener('click', themeToggleHandler);
                document.getElementById('theme-toggle-app').addEventListener('click', themeToggleHandler);

                lucide.createIcons();
                loadInitialData();
            };

            init();
        });
    </script>
</body>

</html>
