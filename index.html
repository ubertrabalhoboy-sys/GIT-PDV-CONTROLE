<script>
document.addEventListener('DOMContentLoaded', () => {

    const firebaseConfig = {
        apiKey: "AIzaSyByZ1r41crqOadLXwHH2v9LgveyCkL6erE",
        authDomain: "pdv-vendas-8a65a.firebaseapp.com",
        projectId: "pdv-vendas-8a65a",
        storageBucket: "pdv-vendas-8a65a.appspot.com",
        messagingSenderId: "37533259212",
        appId: "1:37533259212:web:9e79fecb52aa2b4765b969",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let state = { loggedInUser: null, currentView: '', currentOrder: [], db: { users: [], settings: { storeName: "Minha Loja", goals: {} }, sales: [] } };
    let selectedUserForLogin = null;
    let vendasChartInstance = null;
    let pagamentoChartInstance = null;

    async function fetchData(collectionName, field, operator, value) {
        try {
            let query = db.collection(collectionName);
            if (field && operator && value) {
                query = query.where(field, operator, value);
            }
            const snapshot = await query.get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error(`Erro ao buscar dados de '${collectionName}':`, error);
            showToast(`Falha ao carregar ${collectionName}.`, 'error');
            return [];
        }
    }

    async function saveData(collectionName, data, docId = null) {
        try {
            const docRef = docId ? db.collection(collectionName).doc(docId) : db.collection(collectionName).doc();
            await docRef.set(data, { merge: true }); // Use merge:true to avoid overwriting entire doc
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error(`Erro ao salvar dados em '${collectionName}':`, error);
            showToast(`Erro ao salvar dados.`, 'error');
            return { success: false };
        }
    }
    
    async function deleteData(collectionName, docId) {
        try {
            await db.collection(collectionName).doc(docId).delete();
            return { success: true };
        } catch (error) {
            console.error(`Erro ao deletar documento '${docId}' de '${collectionName}':`, error);
            showToast(`Erro ao deletar dados.`, 'error');
            return { success: false };
        }
    }

    async function loadInitialData() {
        const [users, settingsDoc, storeNameDoc, sales] = await Promise.all([
            fetchData('users'),
            db.collection('settings').doc('goals').get(),
            db.collection('settings').doc('store').get(),
            fetchData('sales') // Fetch all sales on initial load for manager
        ]);

        if (users.length === 0) {
            const gerente = { name: 'gerente', password: '123', role: 'gerente' };
            const { success } = await saveData('users', gerente, 'gerente');
            if (success) {
                showToast('Usuário "gerente" padrão criado!');
                state.db.users = await fetchData('users');
            }
        } else {
            state.db.users = users;
        }

        if (settingsDoc.exists) state.db.settings.goals = settingsDoc.data();
        if (storeNameDoc.exists) state.db.settings.storeName = storeNameDoc.data().name;
        state.db.sales = sales;
    }

    const applyTheme=(t)=>{const h=document.documentElement;if(t==='dark'){h.classList.add('dark');document.getElementById('theme-icon-moon').classList.add('hidden');document.getElementById('theme-icon-sun').classList.remove('hidden')}else{h.classList.remove('dark');document.getElementById('theme-icon-moon').classList.remove('hidden');document.getElementById('theme-icon-sun').classList.add('hidden')}};
    const formatCurrency=v=>new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);
    const formatDate=d=>d ? new Date(d.seconds * 1000).toLocaleString('pt-BR',{dateStyle:'short',timeStyle:'short'}) : '';
    const getDayOfWeek=d=>new Date(d).toLocaleDateString('pt-BR',{weekday:'short'}).replace('.','').slice(0,3);
    const showToast=(m,t='success')=>{const e=document.createElement('div');e.className=`fixed bottom-5 right-5 ${t==='success'?'bg-green-500':'bg-red-500'} text-white py-2 px-4 rounded-lg shadow-lg z-[70] animate-bounce`;e.textContent=m;document.body.appendChild(e);setTimeout(()=>e.remove(),3000)};
    const showConfirmModal=(m,onConfirm)=>{const M=document.getElementById('confirm-modal');M.querySelector('#confirm-modal-message').textContent=m;M.classList.remove('hidden');const c=M.querySelector('#confirm-modal-confirm'),n=M.querySelector('#confirm-modal-cancel');const h=()=>{onConfirm();hide()};const k=()=>hide();const hide=()=>{M.classList.add('hidden');c.removeEventListener('click',h);n.removeEventListener('click',k)};c.addEventListener('click',h,{once:true});n.addEventListener('click',k,{once:true})};

    function renderLoginScreen(){
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        document.getElementById('user-selection-view').classList.remove('hidden');
        document.getElementById('password-view').classList.add('hidden');
        if (state.db.users.length > 0) {
            state.db.users.forEach(user => {
                const userButton = document.createElement('button');
                userButton.className = 'flex flex-col items-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-primary-100 dark:hover:bg-primary-900/50 transition-colors duration-200 transform hover:scale-105 border border-gray-200 dark:border-gray-700';
                userButton.dataset.username = user.name;
                userButton.innerHTML = `<div class="w-16 h-16 mb-2 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center text-gray-500 dark:text-gray-300 text-3xl font-bold">${user.name.charAt(0).toUpperCase()}</div><span class="font-semibold text-gray-800 dark:text-gray-200 text-center">${user.name}</span>`;
                userList.appendChild(userButton);
            });
        } else {
            userList.innerHTML = '<div class="col-span-full text-center text-gray-500"><div class="loader"></div>Carregando usuários...</div>';
        }
        lucide.createIcons();
    }
    
    const logout = async () => {
        state.loggedInUser = null; selectedUserForLogin = null; state.db.sales = [];
        document.getElementById('app').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('password').value = '';
        document.getElementById('login-error').textContent = '';
        await loadInitialData();
        renderLoginScreen();
    };

    const initializeAppUI = () => {
        const user = state.loggedInUser;
        document.getElementById('store-name-sidebar').textContent = state.db.settings.storeName;
        document.getElementById('username-sidebar').textContent = user.name;
        document.getElementById('user-icon').textContent = user.name.charAt(0).toUpperCase();
        const createMenuItem=(v,i,t)=>`<li><a href="#" data-view="${v}" class="flex items-center p-2 text-gray-300 rounded-lg hover:bg-gray-700 hover:text-white group transition-colors"><i data-lucide="${i}" class="w-5 h-5"></i><span class="ml-3">${t}</span></a></li>`;
        const createLogoutItem = () => `<li class="pt-2 mt-2 border-t border-gray-700"><button data-action="logout" class="w-full flex items-center p-2 text-red-400 rounded-lg hover:bg-red-500 hover:text-white group transition-colors"><i data-lucide="log-out" class="w-5 h-5"></i><span class="ml-3">Sair</span></button></li>`;
        const vM=document.getElementById('vendedor-menu'), gM=document.getElementById('gerente-menu');
        vM.innerHTML = ''; gM.innerHTML = '';
        if(user.role==='vendedor'){
            vM.innerHTML = createMenuItem('caixa','shopping-basket','Caixa') + createMenuItem('pedidos','list-ordered','Pedidos') + createMenuItem('relatorios','bar-chart-2','Relatórios') + createLogoutItem();
            vM.classList.remove('hidden'); gM.classList.add('hidden');
            switchView('caixa');
        } else {
            gM.innerHTML = createMenuItem('pedidos','list-ordered','Pedidos') + createMenuItem('relatorios','area-chart','Relatórios') + createMenuItem('configuracoes','settings','Configurações') + createLogoutItem();
            gM.classList.remove('hidden'); vM.classList.add('hidden');
            switchView('pedidos');
        }
        document.getElementById('sidebar').addEventListener('click', e => {
            const link = e.target.closest('a[data-view]'), logoutBtn = e.target.closest('button[data-action="logout"]');
            if (link) { e.preventDefault(); switchView(link.dataset.view); }
            if (logoutBtn) { logout(); }
        });
        lucide.createIcons();
    };

    const switchView = (viewId) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active', 'fade-in'));
        const activeView = document.getElementById(`${viewId}-view`);
        if (activeView) {
            activeView.innerHTML = document.getElementById(`${viewId}-template`).innerHTML;
            activeView.classList.add('active', 'fade-in'); 
            state.currentView = viewId;
            const link = document.querySelector(`#sidebar a[data-view="${viewId}"]`);
            if(link) {
               document.getElementById('current-view-title').textContent = link.querySelector('span').textContent;
               document.querySelectorAll('#sidebar ul li a').forEach(l => l.classList.remove('bg-primary-600', 'text-white'));
               link.classList.add('bg-primary-600', 'text-white');
            }
            lucide.createIcons();
            switch(viewId) {
                case 'caixa': renderCaixa(); break;
                case 'pedidos': renderPedidos(); break;
                case 'relatorios': renderRelatorios(); break;
                case 'configuracoes': renderConfiguracoes(); break;
            }
        }
        showMobileMenu(false);
    };
    
    const sidebar=document.getElementById('sidebar'), overlay=document.getElementById('sidebar-overlay');
    const showMobileMenu=s=>{if(s){sidebar.classList.remove('-translate-x-full');overlay.classList.remove('hidden')}else{sidebar.classList.add('-translate-x-full');overlay.classList.add('hidden')}};

    function showWhatsAppModal(saleId, clientName, clientPhone) {
        const modal = document.getElementById('whatsapp-data-modal');
        modal.querySelector('#whatsapp-sale-id').value = saleId;
        modal.querySelector('#client-name-whatsapp').value = clientName || '';
        modal.querySelector('#client-phone-whatsapp').value = clientPhone || '';
        modal.classList.remove('hidden');
    }

    function hideWhatsAppModal() { document.getElementById('whatsapp-data-modal').classList.add('hidden'); }

    document.getElementById('whatsapp-data-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('save-whatsapp-button');
        btn.disabled = true; btn.textContent = 'Salvando...';
        const saleId = document.getElementById('whatsapp-sale-id').value;
        const clientName = document.getElementById('client-name-whatsapp').value;
        const clientPhone = document.getElementById('client-phone-whatsapp').value;
        await db.collection('sales').doc(saleId).update({ clientName, clientPhone });
        showToast('Dados do cliente salvos!');
        btn.disabled = false; btn.textContent = 'Salvar e Fechar';
        hideWhatsAppModal();
    });

    document.getElementById('skip-whatsapp-button').addEventListener('click', hideWhatsAppModal);
    
    function renderCaixa() {
        // Implementation for Caixa view...
    }
    async function renderPedidos() {
        // Implementation for Pedidos view...
    }
    async function renderRelatorios() {
        // Implementation for Relatorios view...
    }
    
    // --- FIX STARTS HERE ---
    function renderConfiguracoes() {
        const storeNameInput = document.getElementById('config-store-name');
        const metaDiariaInput = document.getElementById('meta-diaria');
        const metaSemanalInput = document.getElementById('meta-semanal');
        const metaMensalInput = document.getElementById('meta-mensal');
        const saveSettingsButton = document.getElementById('save-settings-button');
        const addVendedorForm = document.getElementById('add-vendedor-form');
        const vendedoresList = document.getElementById('vendedores-list');
        const zerarVendasButton = document.getElementById('zerar-vendas-button');
        const exportDiaButton = document.getElementById('export-dia');
        const exportSemanaButton = document.getElementById('export-semana');

        // Populate existing settings
        storeNameInput.value = state.db.settings.storeName;
        metaDiariaInput.value = state.db.settings.goals.daily || '';
        metaSemanalInput.value = state.db.settings.goals.weekly || '';
        metaMensalInput.value = state.db.settings.goals.monthly || '';

        // Function to render the list of sellers
        const renderVendedoresList = () => {
            vendedoresList.innerHTML = '';
            state.db.users.forEach(user => {
                if (user.role === 'vendedor') {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded';
                    li.innerHTML = `<span>${user.name}</span> <button data-id="${user.id}" class="delete-vendedor-btn p-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                    vendedoresList.appendChild(li);
                }
            });
            lucide.createIcons();

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-vendedor-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const userId = e.currentTarget.dataset.id;
                    const user = state.db.users.find(u => u.id === userId);
                    showConfirmModal(`Tem certeza que deseja excluir o vendedor "${user.name}"?`, async () => {
                        const { success } = await deleteData('users', userId);
                        if (success) {
                            showToast('Vendedor excluído com sucesso!');
                            state.db.users = state.db.users.filter(u => u.id !== userId);
                            renderVendedoresList();
                        }
                    });
                });
            });
        };
        renderVendedoresList();

        // Event listener for adding a new seller
        addVendedorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('vendedor-name');
            const passwordInput = document.getElementById('vendedor-password');
            const name = nameInput.value.trim();
            const password = passwordInput.value.trim();

            if (name && password) {
                const newUser = { name, password, role: 'vendedor' };
                const { success, id } = await saveData('users', newUser);
                if (success) {
                    showToast('Vendedor cadastrado com sucesso!');
                    state.db.users.push({ id, ...newUser });
                    nameInput.value = '';
                    passwordInput.value = '';
                    renderVendedoresList();
                }
            }
        });

        // Event listener for saving general settings
        saveSettingsButton.addEventListener('click', async () => {
            const newStoreName = storeNameInput.value.trim();
            const newGoals = {
                daily: parseFloat(metaDiariaInput.value) || 0,
                weekly: parseFloat(metaSemanalInput.value) || 0,
                monthly: parseFloat(metaMensalInput.value) || 0,
            };

            await saveData('settings', { name: newStoreName }, 'store');
            await saveData('settings', newGoals, 'goals');
            
            state.db.settings.storeName = newStoreName;
            state.db.settings.goals = newGoals;
            
            document.getElementById('store-name-sidebar').textContent = newStoreName;
            document.getElementById('login-store-name').textContent = newStoreName;

            showToast('Configurações salvas com sucesso!');
        });
        
        // Event listener for clearing all sales
        zerarVendasButton.addEventListener('click', () => {
            showConfirmModal('Esta ação irá apagar TODOS os registros de vendas permanentemente. Deseja continuar?', async () => {
                showToast('Excluindo vendas... Isso pode levar um momento.', 'info');
                const salesToDelete = await fetchData('sales');
                const deletePromises = salesToDelete.map(sale => deleteData('sales', sale.id));
                await Promise.all(deletePromises);
                state.db.sales = [];
                showToast('Todas as vendas foram zeradas com sucesso!', 'success');
            });
        });

        const exportSalesToCSV = (period) => {
            const now = new Date();
            const salesToExport = state.db.sales.filter(sale => {
                const saleDate = new Date(sale.date.seconds * 1000);
                if (period === 'day') {
                    return saleDate.toDateString() === now.toDateString();
                }
                if (period === 'week') {
                    const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                    return saleDate >= weekStart;
                }
                return false;
            });

            if (salesToExport.length === 0) {
                showToast('Nenhuma venda encontrada para o período selecionado.', 'error');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Data,Vendedor,Cliente,Valor Total,Pagamento,Itens\r\n";

            salesToExport.forEach(sale => {
                const row = [
                    sale.id,
                    formatDate(sale.date),
                    sale.seller,
                    `"${sale.clientName || 'N/A'}"`,
                    sale.total,
                    sale.paymentMethod,
                    `"${sale.items.map(item => `${item.name} (R$${item.value})`).join('; ')}"`
                ].join(',');
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `vendas_${period}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        exportDiaButton.addEventListener('click', () => exportSalesToCSV('day'));
        exportSemanaButton.addEventListener('click', () => exportSalesToCSV('week'));
    }
    // --- FIX ENDS HERE ---
    
    document.getElementById('user-list').addEventListener('click', (e) => {
        const userButton = e.target.closest('button');
        if (!userButton) return;
        selectedUserForLogin = userButton.dataset.username;
        document.getElementById('user-selection-view').classList.add('hidden');
        document.getElementById('password-view').classList.remove('hidden');
        document.getElementById('selected-user-info').innerHTML = `<div class="w-20 h-20 mx-auto mb-3 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center text-4xl font-bold">${selectedUserForLogin.charAt(0).toUpperCase()}</div><h3 class="text-xl font-bold">${selectedUserForLogin}</h3>`;
        document.getElementById('password').value = '';
        document.getElementById('password').focus();
    });

    document.getElementById('back-to-users').addEventListener('click', () => {
        selectedUserForLogin = null;
        document.getElementById('login-error').textContent = '';
        renderLoginScreen();
    });

    document.getElementById('password-form').addEventListener('submit', e => {
        e.preventDefault();
        if (!selectedUserForLogin) return;
        const user = state.db.users.find(u => u.name.toLowerCase() === selectedUserForLogin.toLowerCase());
        const passwordInput = document.getElementById('password');
        if (user && user.password === passwordInput.value) {
            state.loggedInUser = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            passwordInput.value = ''; document.getElementById('login-error').textContent = '';
            initializeAppUI();
        } else {
            document.getElementById('login-error').textContent = 'Senha inválida.';
            document.getElementById('password-view').classList.add('animate-shake');
            setTimeout(() => document.getElementById('password-view').classList.remove('animate-shake'), 500);
        }
    });
    
    const init = async () => {
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        document.getElementById('mobile-menu-button').addEventListener('click',()=>showMobileMenu(true));
        document.getElementById('sidebar-overlay').addEventListener('click',()=>showMobileMenu(false));
        const theme = localStorage.getItem('theme') || 'light';
        applyTheme(theme);
        lucide.createIcons();
        await loadInitialData();
        document.getElementById('login-store-name').textContent = state.db.settings.storeName;
        renderLoginScreen();
    };
    
    init();
});
</script>