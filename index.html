<!DOCTYPE html>
<html lang="pt-BR" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV de Vendas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        html.dark body {
            background-color: #0f172a; /* bg-slate-900 */
        }

        /* Animações */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out forwards;
        }

        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                            950: '#052e16'
                        },
                        slate: {
                           50: '#f8fafc',
                           100: '#f1f5f9',
                           200: '#e2e8f0',
                           300: '#cbd5e1',
                           400: '#94a3b8',
                           500: '#64748b',
                           600: '#475569',
                           700: '#334155',
                           800: '#1e293b',
                           900: '#0f172a',
                           950: '#020617'
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="text-slate-700 dark:text-slate-300">

    <!-- Tela de Login -->
    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center p-4 bg-slate-50 dark:bg-slate-900">
        <div class="w-full max-w-sm mx-auto">
             <div class="absolute top-5 right-5">
                <button id="theme-toggle" type="button" class="text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus:ring-4 focus:ring-slate-200 dark:focus:ring-slate-700 rounded-lg text-sm p-2.5">
                    <i id="theme-icon-sun" data-lucide="sun" class="w-5 h-5 hidden"></i>
                    <i id="theme-icon-moon" data-lucide="moon" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg text-center">
                <div class="mx-auto mb-4 inline-block p-3 bg-primary-100 dark:bg-primary-900/50 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-primary-600 dark:text-primary-400"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </div>
                <h1 id="login-store-name" class="text-2xl font-bold text-slate-900 dark:text-white mb-1">Minha Loja</h1>
                <p class="text-slate-500 dark:text-slate-400 mb-8">Quem está acessando?</p>

                <div id="user-selection-view">
                    <div id="user-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <p class="col-span-full text-center text-slate-500">Carregando usuários...</p>
                    </div>
                </div>

                <div id="password-view" class="hidden">
                    <div id="selected-user-info" class="mb-4"></div>
                    <form id="password-form">
                        <input type="password" id="password" class="w-full px-4 py-2 text-center text-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus:ring-primary-500 focus:border-primary-500" placeholder="Digite sua senha" required>
                        <p id="login-error" class="text-red-500 text-sm mt-2 h-5"></p>
                        <div class="mt-4 flex flex-col sm:flex-row gap-2 justify-center">
                            <button type="button" id="back-to-users" class="w-full sm:w-auto px-5 py-2.5 text-sm font-medium text-slate-700 dark:text-slate-300 focus:outline-none bg-slate-100 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600 hover:bg-slate-200 dark:hover:bg-slate-600">Voltar</button>
                            <button type="submit" class="w-full sm:w-auto text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">Entrar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- App Principal -->
    <div id="app" class="hidden">
        <aside id="sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen transition-transform -translate-x-full sm:translate-x-0 bg-slate-800">
            <div class="h-full px-3 py-4 overflow-y-auto">
                <div class="flex flex-col items-center mb-6 pb-4 border-b border-slate-700">
                    <div id="user-icon" class="w-16 h-16 mb-2 rounded-full bg-primary-600 flex items-center justify-center text-white text-3xl font-bold"></div>
                    <h5 id="username-sidebar" class="text-xl font-semibold text-white"></h5>
                    <span id="store-name-sidebar" class="text-sm text-slate-400"></span>
                </div>
                <ul id="vendedor-menu" class="space-y-2 font-medium"></ul>
                <ul id="gerente-menu" class="space-y-2 font-medium"></ul>
            </div>
        </aside>

        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 sm:hidden"></div>

        <div class="sm:ml-64">
            <header class="sticky top-0 bg-slate-50/80 dark:bg-slate-900/80 backdrop-blur-sm z-20 border-b border-slate-200 dark:border-slate-800">
                <div class="p-4 flex items-center justify-between">
                    <button id="mobile-menu-button" class="sm:hidden text-slate-600 dark:text-slate-300">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <h2 id="current-view-title" class="text-xl font-bold text-slate-900 dark:text-white"></h2>
                    <button id="theme-toggle-app" type="button" class="text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus:ring-4 focus:ring-slate-200 dark:focus:ring-slate-700 rounded-lg text-sm p-2.5">
                       <i id="theme-icon-sun-app" data-lucide="sun" class="w-5 h-5 hidden"></i>
                       <i id="theme-icon-moon-app" data-lucide="moon" class="w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <main class="p-4 md:p-6">
                <div id="caixa-view" class="view"></div>
                <div id="pedidos-view" class="view"></div>
                <div id="metas-view" class="view"></div>
                <div id="relatorios-view" class="view"></div>
                <div id="configuracoes-view" class="view"></div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="finalize-order-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"></div>
    <div id="order-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"></div>
    <div id="whatsapp-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"></div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Confirmação</h3>
            <p id="confirm-modal-message" class="mb-6 text-slate-600 dark:text-slate-400"></p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 py-2 px-4 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors">Cancelar</button>
                <button id="confirm-modal-confirm" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <script type="text/html" id="caixa-template">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Registrar Item</h3>
                <form id="add-item-form" class="space-y-4">
                    <div><label for="item-name" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Nome do Item</label><input type="text" id="item-name" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:border-primary-500 focus:ring-primary-500"></div>
                    <div><label for="item-value" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Valor (R$)</label><input type="number" id="item-value" step="0.01" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:border-primary-500 focus:ring-primary-500"></div>
                    <div>
                        <label for="item-exchange" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Prazo de Troca</label>
                        <select id="item-exchange" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:border-primary-500 focus:ring-primary-500">
                            <option>Sem Troca</option>
                            <option>7 dias</option>
                            <option>15 dias</option>
                            <option>30 dias</option>
                            <option>45 dias</option>
                            <option>60 dias</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-primary-600 text-white py-2.5 px-4 rounded-md hover:bg-primary-700 transition-colors flex items-center justify-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i>Adicionar Item</button>
                </form>
            </div>
            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Pedido Atual</h3>
                <div id="current-order-items" class="space-y-2 mb-4 min-h-[120px]"></div>
                <div class="border-t dark:border-slate-700 pt-4 flex justify-between items-center">
                    <span class="text-xl font-bold text-slate-800 dark:text-slate-100">Total:</span>
                    <span id="current-order-total" class="text-2xl font-bold text-primary-600 dark:text-primary-400">R$ 0,00</span>
                </div>
                <button id="finalize-order-button" class="w-full mt-6 bg-primary-600 text-white py-3 px-4 rounded-md hover:bg-primary-700 transition-colors disabled:bg-slate-400 dark:disabled:bg-slate-600 disabled:cursor-not-allowed flex items-center justify-center gap-2 text-lg"><i data-lucide="check-circle" class="w-6 h-6"></i>Finalizar Pedido</button>
            </div>
        </div>
    </script>

    <script type="text/html" id="pedidos-template">
         <div class="space-y-6">
            <div id="vendedor-pedidos-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md flex items-center gap-4"><div class="bg-blue-100 dark:bg-blue-900/50 p-3 rounded-full"><i data-lucide="shopping-cart" class="w-6 h-6 text-blue-600 dark:text-blue-300"></i></div><div><p class="text-sm text-slate-500 dark:text-slate-400">Pedidos Finalizados</p><p id="pedidos-finalizados" class="text-2xl font-bold text-slate-800 dark:text-slate-100">0</p></div></div>
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md flex items-center gap-4"><div class="bg-green-100 dark:bg-green-900/50 p-3 rounded-full"><i data-lucide="dollar-sign" class="w-6 h-6 text-green-600 dark:text-green-300"></i></div><div><p class="text-sm text-slate-500 dark:text-slate-400">Valor Total</p><p id="valor-total" class="text-2xl font-bold text-slate-800 dark:text-slate-100">R$ 0,00</p></div></div>
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md flex items-center gap-4"><div class="bg-yellow-100 dark:bg-yellow-900/50 p-3 rounded-full"><i data-lucide="receipt-text" class="w-6 h-6 text-yellow-600 dark:text-yellow-300"></i></div><div><p class="text-sm text-slate-500 dark:text-slate-400">Ticket Médio</p><p id="ticket-medio" class="text-2xl font-bold text-slate-800 dark:text-slate-100">R$ 0,00</p></div></div>
            </div>
             
            <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md">
                 <form id="filter-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end pb-4 border-b border-slate-200 dark:border-slate-700">
                     <div class="lg:col-span-2">
                        <label for="filter-date" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Data</label>
                        <input type="date" id="filter-date" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                     </div>
                     <div>
                        <label for="filter-payment" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Pagamento</label>
                        <select id="filter-payment" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                             <option>Todos</option><option>Pix</option><option>Cartão</option><option>Dinheiro</option>
                        </select>
                     </div>
                     <div id="gerente-vendedor-filter-container" class="hidden">
                         <label for="filter-vendedor" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Vendedor</label>
                         <select id="filter-vendedor" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700"></select>
                     </div>
                     <div class="flex gap-2">
                         <button type="submit" class="w-full bg-primary-600 text-white p-2 rounded-md flex items-center justify-center gap-2"><i data-lucide="search" class="w-4 h-4"></i>Buscar</button>
                         <button type="reset" class="w-full bg-slate-500 hover:bg-slate-600 text-white p-2 rounded-md flex items-center justify-center gap-2"><i data-lucide="rotate-cw" class="w-4 h-4"></i>Limpar</button>
                     </div>
                 </form>
                <div class="relative overflow-x-auto pt-4">
                     <table class="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                         <thead class="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400">
                            <tr id="orders-table-header-row">
                                 <th scope="col" class="px-6 py-3">Cliente</th>
                                 <th scope="col" class="px-6 py-3">Data</th>
                                 <th scope="col" class="px-6 py-3">Pagamento</th>
                                 <th scope="col" class="px-6 py-3 text-right">Total</th>
                                 <th scope="col" class="px-6 py-3 text-center">Ações</th>
                            </tr>
                         </thead>
                         <tbody id="orders-table-body"></tbody>
                     </table>
                     <div id="no-orders-found" class="text-center p-8 text-slate-500 hidden">Nenhum pedido encontrado.</div>
                 </div>
            </div>
        </div>
    </script>
    
    <script type="text/html" id="metas-template">
        <div class="space-y-6">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Meu Progresso</h3>
                <div class="space-y-4">
                    <!-- Meta Diária -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-slate-700 dark:text-slate-300">Meta Diária</span>
                            <span id="progresso-diario-texto" class="text-sm font-medium text-slate-700 dark:text-slate-300">R$ 0 / R$ 0</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700">
                            <div id="progresso-diario-barra" class="bg-primary-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- Meta Semanal -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-slate-700 dark:text-slate-300">Meta Semanal</span>
                            <span id="progresso-semanal-texto" class="text-sm font-medium text-slate-700 dark:text-slate-300">R$ 0 / R$ 0</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700">
                            <div id="progresso-semanal-barra" class="bg-primary-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- Meta Mensal -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-slate-700 dark:text-slate-300">Meta Mensal</span>
                            <span id="progresso-mensal-texto" class="text-sm font-medium text-slate-700 dark:text-slate-300">R$ 0 / R$ 0</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-700">
                            <div id="progresso-mensal-barra" class="bg-primary-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md text-center">
                    <i data-lucide="flame" class="w-8 h-8 mx-auto mb-2 text-red-500"></i>
                    <p class="text-sm text-slate-500">Meta Batida (Dias seguidos)</p>
                    <p id="recorde-dias-consecutivos" class="text-2xl font-bold text-slate-800 dark:text-slate-100">0</p>
                </div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md text-center">
                    <i data-lucide="award" class="w-8 h-8 mx-auto mb-2 text-amber-500"></i>
                    <p class="text-sm text-slate-500">Melhor Dia</p>
                    <p id="recorde-melhor-dia" class="text-2xl font-bold text-slate-800 dark:text-slate-100">R$ 0,00</p>
                </div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md text-center">
                    <i data-lucide="trophy" class="w-8 h-8 mx-auto mb-2 text-sky-500"></i>
                    <p class="text-sm text-slate-500">Melhor Semana</p>
                    <p id="recorde-melhor-semana" class="text-2xl font-bold text-slate-800 dark:text-slate-100">R$ 0,00</p>
                </div>
            </div>
        </div>
    </script>

    <script type="text/html" id="relatorios-template">
        <div class="space-y-6">
             <div id="gerente-relatorios-vendedor-select-container" class="hidden bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md">
                <label for="relatorios-vendedor-select" class="block text-sm font-medium mb-1 text-slate-600 dark:text-slate-400">Visualizar Relatório de:</label>
                <select id="relatorios-vendedor-select" class="w-full md:w-1/3 block rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700"></select>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><p class="text-sm text-slate-500">Vendas Hoje</p><p id="relatorio-vendas-hoje" class="text-2xl font-bold text-primary-600">R$ 0,00</p></div>
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><p class="text-sm text-slate-500">Bônus Hoje</p><p id="relatorio-bonus-dia" class="text-2xl font-bold text-primary-600">0</p></div>
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><p class="text-sm text-slate-500">Vendas na Semana</p><p id="relatorio-vendas-semana" class="text-2xl font-bold text-slate-800 dark:text-slate-100">R$ 0,00</p></div>
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><p class="text-sm text-slate-500">Bônus na Semana</p><p id="relatorio-bonus-semana" class="text-2xl font-bold text-slate-800 dark:text-slate-100">0</p></div>
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><p class="text-sm text-slate-500">Vendas no Mês</p><p id="relatorio-vendas-mes" class="text-2xl font-bold text-slate-800 dark:text-slate-100">R$ 0,00</p></div>
                 <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md"><p class="text-sm text-slate-500">Bônus no Mês</p><p id="relatorio-bonus-mes" class="text-2xl font-bold text-slate-800 dark:text-slate-100">0</p></div>
             </div>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                 <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                     <h3 class="font-bold mb-4 text-slate-900 dark:text-white">Vendas nos últimos 7 dias</h3>
                     <div class="h-80"><canvas id="vendas-semana-chart"></canvas></div>
                 </div>
                 <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                     <h3 class="font-bold mb-4 text-slate-900 dark:text-white">Formas de Pagamento</h3>
                     <div class="h-80"><canvas id="pagamento-chart"></canvas></div>
                 </div>
             </div>
        </div>
    </script>
    
    <script type="text/html" id="configuracoes-template">
        <div class="space-y-6">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Painel Administrativo</h3>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-slate-200 dark:border-slate-700 pt-4">
                    <div>
                         <h4 class="text-md font-semibold text-slate-800 dark:text-slate-200 mb-2">Configurações da Loja</h4>
                         <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Nome da Loja</label>
                         <input type="text" id="config-store-name" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                         <button id="save-settings-button" class="mt-2 bg-primary-600 text-white py-2 px-4 rounded-md hover:bg-primary-700 transition-colors text-sm">Salvar Nome</button>
                    </div>
                     <div>
                         <h4 class="text-md font-semibold text-red-600 dark:text-red-500 mb-2">Zona de Perigo</h4>
                         <p class="text-xs text-slate-500 mb-2">Esta ação não pode ser desfeita e removerá permanentemente todas as vendas do sistema.</p>
                         <button id="delete-all-sales-button" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors text-sm">Zerar Todas as Vendas</button>
                     </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Definir Metas</h3>
                <form id="goals-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="meta-diaria" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Meta Diária (R$)</label>
                        <input type="number" id="meta-diaria" step="0.01" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                    </div>
                    <div>
                        <label for="meta-semanal" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Meta Semanal (R$)</label>
                        <input type="number" id="meta-semanal" step="0.01" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                    </div>
                     <div>
                        <label for="meta-mensal" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Meta Mensal (R$)</label>
                        <input type="number" id="meta-mensal" step="0.01" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                    </div>
                </form>
                <button id="save-goals-button" class="mt-4 bg-primary-600 text-white py-2 px-4 rounded-md hover:bg-primary-700 transition-colors text-sm">Salvar Metas</button>
            </div>

            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Exportar Vendas (CSV)</h3>
                <div class="space-y-4 border-t dark:border-slate-700 pt-4">
                    <div>
                        <label for="export-vendedor-select" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Filtrar por Vendedor</label>
                        <select id="export-vendedor-select" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700"></select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <button id="export-today-btn" class="w-full bg-slate-500 text-white p-2 rounded-md hover:bg-slate-600 transition-colors text-sm flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i>Vendas do Dia</button>
                        <button id="export-week-btn" class="w-full bg-slate-500 text-white p-2 rounded-md hover:bg-slate-600 transition-colors text-sm flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i>Vendas da Semana</button>
                        <button id="export-month-btn" class="w-full bg-slate-500 text-white p-2 rounded-md hover:bg-slate-600 transition-colors text-sm flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i>Vendas do Mês</button>
                    </div>
                    <div class="border-t dark:border-slate-700 pt-4">
                        <p class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Exportar por data específica:</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="start-date" class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Data de Início</label>
                                <input type="date" id="start-date" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-sm">
                            </div>
                            <div>
                                <label for="end-date" class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Data Final</label>
                                <input type="date" id="end-date" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-sm">
                            </div>
                        </div>
                        <button id="export-range-btn" class="w-full mt-2 bg-primary-600 text-white p-2 rounded-md hover:bg-primary-700 transition-colors text-sm flex items-center justify-center gap-2"><i data-lucide="download-cloud" class="w-4 h-4"></i>Exportar Período</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Adicionar Novo Vendedor</h3>
                    <form id="add-vendedor-form" class="space-y-4">
                        <div>
                            <label for="vendedor-name" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Nome</label>
                            <input type="text" id="vendedor-name" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                        </div>
                        <div>
                            <label for="vendedor-password" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Senha</label>
                            <input type="password" id="vendedor-password" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700">
                        </div>
                        <button type="submit" class="w-full bg-primary-600 text-white py-2 px-4 rounded-md hover:bg-primary-700 transition-colors">Salvar Vendedor</button>
                    </form>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Vendedores Cadastrados</h3>
                    <ul id="vendedores-list" class="space-y-2"></ul>
                </div>
            </div>
        </div>
    </script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, doc, addDoc, deleteDoc, setDoc, query, where, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByZ1r41crqOadLXwHH2v9LgveyCkL6erE",
            authDomain: "pdv-vendas-8a65a.firebaseapp.com",
            projectId: "pdv-vendas-8a65a",
            storageBucket: "pdv-vendas-8a65a.firebasestorage.app",
            messagingSenderId: "37533259212",
            appId: "1:37533259212:web:9e79fecb52aa2b4765b969",
            measurementId: "G-7PYWX52SEG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            let state = {
                loggedInUser: null,
                currentView: '',
                currentOrder: [],
                db: {
                    users: [],
                    settings: { 
                        storeName: "Minha Loja",
                        goals: { daily: 150, weekly: 1000, monthly: 4000 }
                    },
                    sales: []
                },
                listeners: { users: null, sales: null }
            };
            let selectedUserForLogin = null;
            let vendasChartInstance = null;
            let pagamentoChartInstance = null;

            async function loadInitialData() {
                try {
                    const settingsRef = doc(db, "settings", "storeConfig");
                    const settingsSnap = await getDocs(collection(db, "settings"));
                    if (!settingsSnap.empty) {
                        const settingsData = settingsSnap.docs[0].data();
                        state.db.settings = { ...state.db.settings, ...settingsData };
                    } else {
                       await setDoc(settingsRef, state.db.settings);
                    }
                    document.getElementById('login-store-name').textContent = state.db.settings.storeName;

                    const usersQuery = query(collection(db, "users"));
                    const usersSnapshot = await getDocs(usersQuery);

                    if (usersSnapshot.empty) {
                        const gerente = { name: 'gerente', password: '123', role: 'gerente' };
                        await addDoc(collection(db, "users"), gerente);
                        showToast('Usuário "gerente" criado com sucesso!', 'success');
                        state.db.users.push(gerente);
                    } else {
                        state.db.users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }
                } catch (error) {
                    console.error("Erro ao carregar dados iniciais:", error);
                    showToast('Falha ao conectar com o banco de dados.', 'error');
                }
                renderLoginScreen();
            }
            
            const applyTheme = (t) => {
                const h = document.documentElement;
                const isDark = t === 'dark';
                h.classList.toggle('dark', isDark);
                ['theme-icon-moon', 'theme-icon-moon-app'].forEach(id => document.getElementById(id)?.classList.toggle('hidden', isDark));
                ['theme-icon-sun', 'theme-icon-sun-app'].forEach(id => document.getElementById(id)?.classList.toggle('hidden', !isDark));
            };
            const formatCurrency = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
            const formatDate = d => {
                if (d && d.toDate) { 
                    return d.toDate().toLocaleDateString('pt-BR');
                }
                return new Date(d).toLocaleDateString('pt-BR');
            };
            const showToast = (m, t = 'success') => { const e = document.createElement('div'); e.className = `fixed bottom-5 right-5 ${t === 'success' ? 'bg-primary-600' : 'bg-red-600'} text-white py-2 px-4 rounded-lg shadow-lg z-[70] animate-bounce`; e.textContent = m; document.body.appendChild(e); setTimeout(() => e.remove(), 3000) };
            const showConfirmModal = (m, onConfirm) => { const M = document.getElementById('confirm-modal'); M.querySelector('#confirm-modal-message').textContent = m; M.classList.remove('hidden'); const c = M.querySelector('#confirm-modal-confirm'), n = M.querySelector('#confirm-modal-cancel'); const h = () => { onConfirm(); hide() }; const k = () => hide(); const hide = () => { M.classList.add('hidden'); c.removeEventListener('click', h); n.removeEventListener('click', k) }; c.addEventListener('click', h, { once: true }); n.addEventListener('click', k, { once: true }) };

            function exportToCSV(data, filename) {
                if (data.length === 0) {
                    showToast('Nenhuma venda encontrada para exportar.', 'error');
                    return;
                }

                const formatItems = (items) => {
                    return items.map(item => `${item.name} (${formatCurrency(item.value)})`).join('; ');
                };

                const headers = [
                    "ID da Venda", "Data", "Cliente", "Telefone", "Vendedor", 
                    "Itens", "Total", "Forma de Pagamento", "Bônus"
                ];
                
                const rows = data.map(sale => [
                    sale.id,
                    new Date(sale.date.seconds * 1000).toLocaleString('pt-BR'),
                    sale.clientName,
                    sale.clientPhone || '',
                    sale.vendedor,
                    formatItems(sale.items),
                    sale.total,
                    sale.paymentMethod,
                    sale.bonus
                ]);

                let csvContent = "data:text/csv;charset=utf-8," 
                    + headers.join(",") + "\n" 
                    + rows.map(e => e.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",")).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${filename}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function renderLoginScreen() {
                const userList = document.getElementById('user-list');
                userList.innerHTML = '';
                document.getElementById('user-selection-view').classList.remove('hidden');
                document.getElementById('password-view').classList.add('hidden');

                if (state.db.users.length > 0) {
                    state.db.users.forEach(user => {
                        const userButton = document.createElement('button');
                        userButton.className = 'flex flex-col items-center p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors duration-200 transform hover:scale-105 border border-slate-200 dark:border-slate-700';
                        userButton.dataset.username = user.name;
                        userButton.innerHTML = `<div class="w-16 h-16 mb-2 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-slate-500 dark:text-slate-300 text-3xl font-bold">${user.name.charAt(0).toUpperCase()}</div><span class="font-semibold text-slate-800 dark:text-slate-200 text-center">${user.name}</span>`;
                        userList.appendChild(userButton);
                    });
                } else {
                    userList.innerHTML = '<p class="col-span-full text-center text-slate-500">Nenhum usuário encontrado.</p>';
                }
            }

            document.getElementById('user-list').addEventListener('click', (e) => {
                const userButton = e.target.closest('button');
                if (!userButton) return;
                selectedUserForLogin = userButton.dataset.username;
                document.getElementById('user-selection-view').classList.add('hidden');
                document.getElementById('password-view').classList.remove('hidden');
                document.getElementById('selected-user-info').innerHTML = `<div class="w-20 h-20 mx-auto mb-3 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-slate-500 dark:text-slate-300 text-4xl font-bold">${selectedUserForLogin.charAt(0).toUpperCase()}</div><h3 class="text-xl font-bold text-slate-900 dark:text-white">${selectedUserForLogin}</h3>`;
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            });

            document.getElementById('back-to-users').addEventListener('click', () => {
                selectedUserForLogin = null;
                document.getElementById('login-error').textContent = '';
                renderLoginScreen();
            });

            document.getElementById('password-form').addEventListener('submit', e => {
                e.preventDefault();
                const user = state.db.users.find(u => u.name.toLowerCase() === selectedUserForLogin.toLowerCase());
                const passwordInput = document.getElementById('password');

                if (user && user.password === passwordInput.value) {
                    state.loggedInUser = user;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    passwordInput.value = ''; document.getElementById('login-error').textContent = '';
                    initializeAppUI();
                } else {
                    document.getElementById('login-error').textContent = 'Senha inválida.';
                    document.getElementById('password-view').classList.add('animate-shake');
                    setTimeout(() => document.getElementById('password-view').classList.remove('animate-shake'), 500);
                }
            });

            const logout = () => {
                if (state.listeners.users) state.listeners.users();
                if (state.listeners.sales) state.listeners.sales();
                state.listeners = { users: null, sales: null };
                Object.assign(state, { loggedInUser: null, currentOrder: [], db: { ...state.db, sales: [], users: [] }});
                selectedUserForLogin = null;
                document.getElementById('app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                loadInitialData();
            };

            const initializeAppUI = () => {
                const user = state.loggedInUser;
                document.getElementById('store-name-sidebar').textContent = state.db.settings.storeName;
                document.getElementById('username-sidebar').textContent = user.name;
                document.getElementById('user-icon').textContent = user.name.charAt(0).toUpperCase();

                const createMenuItem = (v, i, t) => `<li><a href="#" data-view="${v}" class="flex items-center p-2 text-slate-300 rounded-lg hover:bg-slate-700 hover:text-white group transition-colors"><i data-lucide="${i}" class="w-5 h-5"></i><span class="ml-3">${t}</span></a></li>`;
                const createLogoutItem = () => `<li class="pt-2 mt-2 border-t border-slate-700"><button data-action="logout" class="w-full flex items-center p-2 text-red-400 rounded-lg hover:bg-red-500 hover:text-white group transition-colors"><i data-lucide="log-out" class="w-5 h-5"></i><span class="ml-3">Sair</span></button></li>`;

                const vM = document.getElementById('vendedor-menu'), gM = document.getElementById('gerente-menu');
                vM.innerHTML = ''; gM.innerHTML = '';

                if (user.role === 'vendedor') {
                    vM.innerHTML = createMenuItem('caixa', 'shopping-basket', 'Caixa') + createMenuItem('pedidos', 'list-ordered', 'Pedidos') + createMenuItem('metas', 'target', 'Metas') + createMenuItem('relatorios', 'bar-chart-2', 'Relatórios') + createLogoutItem();
                    vM.classList.remove('hidden'); gM.classList.add('hidden');
                    switchView('caixa');
                } else {
                    gM.innerHTML = createMenuItem('pedidos', 'list-ordered', 'Pedidos') + createMenuItem('relatorios', 'area-chart', 'Relatórios') + createMenuItem('configuracoes', 'settings', 'Configurações') + createLogoutItem();
                    gM.classList.remove('hidden'); vM.classList.add('hidden');
                    switchView('pedidos');
                }

                document.getElementById('sidebar').addEventListener('click', e => {
                    const link = e.target.closest('a[data-view]'), logoutBtn = e.target.closest('button[data-action="logout"]');
                    if (link) { e.preventDefault(); switchView(link.dataset.view); }
                    if (logoutBtn) { logout(); }
                });
                lucide.createIcons();
            };

            const switchView = (viewId) => {
                if(state.listeners.sales) { state.listeners.sales(); state.listeners.sales = null; }

                document.querySelectorAll('.view').forEach(v => v.classList.remove('active', 'fade-in'));
                const activeView = document.getElementById(`${viewId}-view`);
                if (activeView) {
                    activeView.classList.add('active', 'fade-in'); state.currentView = viewId;
                    const link = document.querySelector(`#sidebar a[data-view="${viewId}"]`);
                    if (link) {
                        document.getElementById('current-view-title').textContent = link.querySelector('span').textContent;
                        document.querySelectorAll('#sidebar ul li a').forEach(l => l.classList.remove('bg-slate-700', 'text-white'));
                        link.classList.add('bg-slate-700', 'text-white');
                    }
                    renderViewContent(viewId);
                }
                showMobileMenu(false);
            };

            const renderViewContent = (viewId) => {
                const viewContainer = document.getElementById(`${viewId}-view`);
                viewContainer.innerHTML = document.getElementById(`${viewId}-template`).innerHTML;
                lucide.createIcons();
                switch (viewId) {
                    case 'caixa': renderCaixa(); break;
                    case 'pedidos': renderPedidos(); break;
                    case 'metas': renderMetas(); break;
                    case 'relatorios': renderRelatorios(); break;
                    case 'configuracoes': renderConfiguracoes(); break;
                }
            };
            
            const sidebar = document.getElementById('sidebar'), overlay = document.getElementById('sidebar-overlay');
            const showMobileMenu = s => { if (s) { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden') } else { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden') } };
            document.getElementById('mobile-menu-button').addEventListener('click', () => showMobileMenu(true));
            overlay.addEventListener('click', () => showMobileMenu(false));

            function showWhatsAppModal(saleData) {
                const modal = document.getElementById('whatsapp-confirm-modal');
                if (!modal) return;

                const storeName = state.db.settings.storeName;
                const saleDate = new Date().toLocaleString('pt-BR', {dateStyle: 'short', timeStyle: 'short'});
                
                let itemsText = saleData.items.map(item => 
                    `- ${item.name} (${item.exchange}) - ${formatCurrency(item.value)}`
                ).join('\n');

                const couponText = `🧾 *Comprovante de Venda* 🧾\n\n*${storeName}*\n\n*Data:* ${saleDate}\n*Cliente:* ${saleData.clientName}\n\n*Itens:*\n${itemsText}\n\n*Total:* *${formatCurrency(saleData.total)}*\n*Vendedor:* ${saleData.vendedor}\n\nObrigado pela sua compra!`;

                const whatsAppNumber = saleData.clientPhone.replace(/\D/g, ''); // Clean phone number
                const encodedText = encodeURIComponent(couponText);
                const whatsappUrl = `https://wa.me/55${whatsAppNumber}?text=${encodedText}`;

                modal.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-md p-6 m-4 fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Venda Finalizada</h3>
                            <button id="close-whatsapp-modal" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 p-1 rounded-full">&times;</button>
                        </div>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Deseja enviar o comprovante para o cliente via WhatsApp?</p>
                        
                        <div class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-md mb-6 whitespace-pre-wrap text-xs text-slate-700 dark:text-slate-300 font-mono overflow-auto max-h-48">${couponText.replace(/\*/g, '')}</div>

                        <div class="flex flex-col sm:flex-row justify-end gap-3">
                            <button id="close-whatsapp-modal-btn" class="bg-slate-200 dark:bg-slate-600 py-2 px-4 rounded-md">Fechar</button>
                            <button id="send-whatsapp-btn" class="bg-green-500 text-white py-2 px-4 rounded-md flex items-center justify-center gap-2 ${!whatsAppNumber ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-600'}" ${!whatsAppNumber ? 'disabled' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943s-.182-.133-.38-.232z"/></svg>
                                Enviar via WhatsApp
                            </button>
                        </div>
                    </div>
                `;
                modal.classList.remove('hidden');

                const close = () => modal.classList.add('hidden');
                modal.querySelector('#close-whatsapp-modal').addEventListener('click', close);
                modal.querySelector('#close-whatsapp-modal-btn').addEventListener('click', close);
                if(whatsAppNumber) {
                    modal.querySelector('#send-whatsapp-btn').addEventListener('click', () => {
                        window.open(whatsappUrl, '_blank');
                        close();
                    });
                }
            }


            function renderCaixa() {
                const c=document.getElementById('caixa-view'),itemsContainer=c.querySelector('#current-order-items'),totalEl=c.querySelector('#current-order-total'),finalizeBtn=c.querySelector('#finalize-order-button'),addForm=c.querySelector('#add-item-form'),modalContainer=document.getElementById('finalize-order-modal');
                const updateUI=()=>{itemsContainer.innerHTML='';if(state.currentOrder.length===0){itemsContainer.innerHTML='<p id="no-items-message" class="text-slate-500 dark:text-slate-400 text-center py-4">Nenhum item adicionado.</p>';finalizeBtn.disabled=true}else{state.currentOrder.forEach((item,i)=>{const el=document.createElement('div');el.className='flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 p-3 rounded-md';el.innerHTML=`<div><p class="font-semibold text-slate-800 dark:text-slate-200">${item.name}</p><p class="text-xs text-slate-500 dark:text-slate-400">Troca: ${item.exchange || 'N/A'}</p></div><div class="flex items-center gap-4"><span class="font-semibold text-slate-800 dark:text-slate-200">${formatCurrency(item.value)}</span><button data-index="${i}" class="remove-item-btn text-red-500 hover:text-red-700 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;itemsContainer.appendChild(el)});finalizeBtn.disabled=false}
                totalEl.textContent=formatCurrency(state.currentOrder.reduce((sum,i)=>sum+i.value,0));lucide.createIcons()};
                addForm.addEventListener('submit',e=>{e.preventDefault();state.currentOrder.push({name:c.querySelector('#item-name').value,value:parseFloat(c.querySelector('#item-value').value),exchange:c.querySelector('#item-exchange').value});updateUI();addForm.reset(); c.querySelector('#item-name').focus()});
                itemsContainer.addEventListener('click',e=>{const b=e.target.closest('.remove-item-btn');if(b){state.currentOrder.splice(b.dataset.index,1);updateUI()}});
                finalizeBtn.addEventListener('click',()=>{modalContainer.classList.remove('hidden');modalContainer.innerHTML=`<div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-lg p-6 m-4 fade-in"><h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Finalizar Pedido</h2><form id="finalize-order-form" class="space-y-4"><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Nome do Cliente</label><input type="text" id="client-name" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700"></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Telefone (WhatsApp)</label><input type="tel" id="client-phone" class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700" placeholder="Ex: 11987654321"></div><div><label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Forma de Pagamento</label><select id="payment-method" required class="block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700"><option>Pix</option><option>Cartão</option><option>Dinheiro</option></select></div><div class="pt-4 flex justify-end gap-4"><button type="button" id="cancel-finalize-button" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="bg-primary-600 text-white py-2 px-4 rounded-md">Confirmar Venda</button></div></form></div>`;
                modalContainer.querySelector('#cancel-finalize-button').addEventListener('click',()=>modalContainer.classList.add('hidden'));
                modalContainer.querySelector('#finalize-order-form').addEventListener('submit',async e=>{
                    e.preventDefault();
                    const total=state.currentOrder.reduce((s,i)=>s+i.value,0);
                    const saleData={clientName:modalContainer.querySelector('#client-name').value,clientPhone:modalContainer.querySelector('#client-phone').value,paymentMethod:modalContainer.querySelector('#payment-method').value,items:state.currentOrder, total:total,bonus:Math.floor(total/80)*2,date: new Date(),vendedor:state.loggedInUser.name,status:'Finalizado'};
                    try {
                        await addDoc(collection(db, "sales"), saleData);
                        showToast('Venda registrada com sucesso!', 'success');
                        modalContainer.classList.add('hidden');
                        showWhatsAppModal(saleData);
                        state.currentOrder=[];
                        updateUI();
                    } catch (error) { showToast('Erro ao registrar a venda.', 'error'); }
                })});
                updateUI();
            }

            function renderPedidos() {
                const c = document.getElementById('pedidos-view');
                const isGerente = state.loggedInUser.role === 'gerente';
                
                if (isGerente) {
                    c.querySelector('#vendedor-pedidos-dashboard')?.classList.add('hidden');
                    c.querySelector('#gerente-vendedor-filter-container').classList.remove('hidden');
                    if (!c.querySelector('#orders-table-header-row').innerText.includes('Vendedor')) {
                        c.querySelector('#orders-table-header-row').insertAdjacentHTML('afterbegin', '<th scope="col" class="px-6 py-3">Vendedor</th>');
                    }
                    const select = c.querySelector('#filter-vendedor');
                    select.innerHTML = '<option value="Todos">Todos</option>';
                    const vendedores = [...new Set(state.db.users.filter(u => u.role === 'vendedor').map(u => u.name))];
                    vendedores.forEach(name => {
                        select.innerHTML += `<option value="${name}">${name}</option>`;
                    });
                }

                const updateDashboard = (sales) => {
                    if (isGerente) return;
                    const totalSales = sales.length;
                    const totalValue = sales.reduce((sum, order) => sum + parseFloat(order.total || 0), 0);
                    c.querySelector('#pedidos-finalizados').textContent = totalSales;
                    c.querySelector('#valor-total').textContent = formatCurrency(totalValue);
                    c.querySelector('#ticket-medio').textContent = formatCurrency(totalSales > 0 ? totalValue / totalSales : 0);
                };

                const renderTable = (sales) => {
                    const tbody = c.querySelector('#orders-table-body');
                    tbody.innerHTML = '';
                    if (!sales || sales.length === 0) {
                        c.querySelector('#no-orders-found').style.display = 'table-row';
                        tbody.innerHTML = '<tr><td colspan="10" class="text-center p-8 text-slate-500">Nenhum pedido encontrado.</td></tr>';
                    } else {
                        c.querySelector('#no-orders-found').style.display = 'none';
                        sales.forEach(s => {
                            const r = document.createElement('tr');
                            r.className = 'bg-white dark:bg-slate-800 border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600';
                            r.innerHTML = 
                                `${isGerente ? `<td class="px-6 py-4">${s.vendedor}</td>` : ''}
                                <td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${s.clientName}</td>
                                <td class="px-6 py-4">${new Date(s.date.seconds * 1000).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' })}</td>
                                <td class="px-6 py-4">${s.paymentMethod}</td>
                                <td class="px-6 py-4 text-right font-semibold text-slate-800 dark:text-slate-100">${formatCurrency(s.total)}</td>
                                <td class="px-6 py-4 text-center">
                                    <button data-order-id="${s.id}" class="view-details-btn text-primary-600 hover:underline">Detalhes</button>
                                </td>`;
                            tbody.appendChild(r);
                        });
                    }
                };

                const filterAndRender = (allSales) => {
                    let sales = allSales || [];
                    const filters = {
                        date: c.querySelector('#filter-date').value,
                        payment: c.querySelector('#filter-payment').value,
                        vendedor: isGerente ? c.querySelector('#filter-vendedor').value : null
                    };
                    if (filters.date) {
                         const filterDate = new Date(filters.date + 'T00:00:00');
                         sales = sales.filter(s => s.date.toDate().toLocaleDateString('pt-BR') === filterDate.toLocaleDateString('pt-BR'));
                    }
                    if (filters.payment && filters.payment !== 'Todos') {
                        sales = sales.filter(s => s.paymentMethod === filters.payment);
                    }
                    if (isGerente && filters.vendedor && filters.vendedor !== 'Todos') {
                        sales = sales.filter(s => s.vendedor === filters.vendedor);
                    }
                    updateDashboard(sales);
                    renderTable(sales);
                };
                
                let q;
                if (isGerente) {
                    q = query(collection(db, "sales"), orderBy("date", "desc"));
                } else {
                    q = query(collection(db, "sales"), where("vendedor", "==", state.loggedInUser.name), orderBy("date", "desc"));
                }

                state.listeners.sales = onSnapshot(q, (snapshot) => {
                    const allSales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.db.sales = allSales;
                    filterAndRender(allSales);
                }, (error) => {
                    console.error("Erro ao buscar pedidos: ", error)
                    if (error.code === 'failed-precondition') {
                         const tbody = c.querySelector('#orders-table-body');
                         tbody.innerHTML = `<tr><td colspan="10" class="text-center p-8 text-red-500"><b>Erro de Banco de Dados:</b> A consulta atual precisa de um índice. Por favor, acesse seu painel do Firebase e crie o índice conforme a mensagem de erro no console do navegador.</td></tr>`;
                     }
                });

                c.querySelector('#filter-form').addEventListener('submit', e => { e.preventDefault(); filterAndRender(state.db.sales); });
                c.querySelector('#filter-form').addEventListener('reset', () => { setTimeout(() => filterAndRender(state.db.sales), 0); });
                c.querySelector('#orders-table-body').addEventListener('click', e => {
                    const b = e.target.closest('.view-details-btn');
                    if (b) {
                        const order = state.db.sales.find(s => s.id == b.dataset.orderId);
                        if (order) {
                            const m = document.getElementById('order-details-modal');
                            m.classList.remove('hidden');
                            const itemsList = order.items.map(i => `<li>${i.name} (${formatCurrency(i.value)})</li>`).join('');
                            m.innerHTML = `<div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-lg p-6 m-4 fade-in"><div class="flex justify-between items-center border-b dark:border-slate-700 pb-3 mb-4"><h2 class="text-2xl font-bold text-slate-900 dark:text-white">Detalhes do Pedido</h2><button id="close-details-modal" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button></div><div><p><strong>Cliente:</strong> ${order.clientName}</p><p><strong>Telefone:</strong> ${order.clientPhone || 'Não informado'}</p><p><strong>Data:</strong> ${new Date(order.date.seconds * 1000).toLocaleString('pt-BR')}</p><p><strong>Vendedor:</strong> ${order.vendedor}</p><hr class="my-2 dark:border-slate-700"><p><strong>Itens:</strong></p><ul class="list-disc list-inside ml-4">${itemsList}</ul><hr class="my-2 dark:border-slate-700"><p class="text-lg font-bold"><strong>Total:</strong> ${formatCurrency(order.total)}</p><p><strong>Pagamento:</strong> ${order.paymentMethod}</p></div></div>`;
                            m.querySelector('#close-details-modal').addEventListener('click', () => m.classList.add('hidden'));
                            lucide.createIcons();
                        }
                    }
                });
            }

            function renderMetas(){
                const c = document.getElementById('metas-view');
                if (!c) return;
                const goals = state.db.settings.goals;

                const updateGoalsUI = (sales) => {
                    const now = new Date();
                    const todayStart = new Date(new Date().setHours(0, 0, 0, 0));
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const dayOfWeek = now.getDay();
                    const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    const weekStart = new Date(new Date().setDate(diff));
                    weekStart.setHours(0, 0, 0, 0);
                    
                    const vendasHoje = sales.filter(s => s.date.toDate() >= todayStart).reduce((sum, s) => sum + s.total, 0);
                    const vendasSemana = sales.filter(s => s.date.toDate() >= weekStart).reduce((sum, s) => sum + s.total, 0);
                    const vendasMes = sales.filter(s => s.date.toDate() >= monthStart).reduce((sum, s) => sum + s.total, 0);

                    const salesByDay = sales.reduce((acc, s) => {
                        const day = s.date.toDate().toISOString().split('T')[0];
                        acc[day] = (acc[day] || 0) + s.total;
                        return acc;
                    }, {});

                    const melhorDiaValor = Math.max(0, ...Object.values(salesByDay));

                    const getWeekNumber = (d) => {
                        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                        var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
                        return `${d.getUTCFullYear()}-W${weekNo}`;
                    }
                    const salesByWeek = sales.reduce((acc, s) => {
                        const week = getWeekNumber(s.date.toDate());
                        acc[week] = (acc[week] || 0) + s.total;
                        return acc;
                    }, {});
                    const melhorSemanaValor = Math.max(0, ...Object.values(salesByWeek));
                    
                    let streak = 0;
                    const sortedDays = Object.keys(salesByDay).sort((a,b) => new Date(b) - new Date(a));
                    let currentDay = new Date(new Date().setHours(0,0,0,0));
                    for(let i = 0; i < 365; i++){
                        const dayStr = currentDay.toISOString().split('T')[0];
                        const daySales = salesByDay[dayStr] || 0;
                        if(daySales >= (goals.daily || 0.01)){
                            streak++;
                        } else {
                             if (!sortedDays.includes(dayStr) && currentDay < todayStart) { break; }
                        }
                        currentDay.setDate(currentDay.getDate() - 1);
                    }

                    const updateProgressBar = (barId, textId, current, goal) => {
                        const percentage = Math.min(100, (current / (goal || 1)) * 100);
                        document.getElementById(barId).style.width = `${percentage}%`;
                        document.getElementById(textId).textContent = `${formatCurrency(current)} / ${formatCurrency(goal)}`;
                    }
                    
                    updateProgressBar('progresso-diario-barra', 'progresso-diario-texto', vendasHoje, goals.daily);
                    updateProgressBar('progresso-semanal-barra', 'progresso-semanal-texto', vendasSemana, goals.weekly);
                    updateProgressBar('progresso-mensal-barra', 'progresso-mensal-texto', vendasMes, goals.monthly);
                    document.getElementById('recorde-dias-consecutivos').textContent = streak;
                    document.getElementById('recorde-melhor-dia').textContent = formatCurrency(melhorDiaValor);
                    document.getElementById('recorde-melhor-semana').textContent = formatCurrency(melhorSemanaValor);
                };

                const q = query(collection(db, "sales"), where("vendedor", "==", state.loggedInUser.name), orderBy("date", "desc"));
                state.listeners.sales = onSnapshot(q, (snapshot) => {
                    const mySales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.db.sales = mySales;
                    updateGoalsUI(mySales);
                }, (error) => {
                    console.error("Erro ao buscar metas: ", error);
                     if (error.code === 'failed-precondition') {
                         c.innerHTML = `<div class="text-center p-8 text-red-500"><b>Erro de Banco de Dados:</b> A consulta atual precisa de um índice. Por favor, acesse seu painel do Firebase e crie o índice conforme a mensagem de erro no console do navegador.</div>`;
                     }
                });
            }

            function renderConfiguracoes() {
                const c=document.getElementById('configuracoes-view');
                c.querySelector('#config-store-name').value = state.db.settings.storeName;
                c.querySelector('#meta-diaria').value = state.db.settings.goals?.daily || 0;
                c.querySelector('#meta-semanal').value = state.db.settings.goals?.weekly || 0;
                c.querySelector('#meta-mensal').value = state.db.settings.goals?.monthly || 0;
                let allSalesForExport = [];

                const exportVendedorSelect = c.querySelector('#export-vendedor-select');
                exportVendedorSelect.innerHTML = '<option value="Todos">Todos os Vendedores</option>';
                const vendedores = state.db.users.filter(u => u.role === 'vendedor').map(u => u.name);
                vendedores.forEach(name => {
                    exportVendedorSelect.innerHTML += `<option value="${name}">${name}</option>`;
                });

                const q = query(collection(db, "sales"));
                state.listeners.sales = onSnapshot(q, (snapshot) => {
                    allSalesForExport = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }, (error) => {
                    console.error("Erro ao buscar vendas para exportação:", error);
                    showToast('Erro ao carregar vendas para exportar.', 'error');
                });


                const getFilteredSales = () => {
                    const selectedVendedor = exportVendedorSelect.value;
                    if (selectedVendedor === 'Todos') {
                        return allSalesForExport;
                    }
                    return allSalesForExport.filter(s => s.vendedor === selectedVendedor);
                };
                
                c.querySelector('#export-today-btn').addEventListener('click', () => {
                    const today = new Date();
                    const salesToExport = getFilteredSales().filter(s => s.date.toDate().toDateString() === today.toDateString());
                    const filename = `vendas_dia_${today.toISOString().split('T')[0]}_${exportVendedorSelect.value}`;
                    exportToCSV(salesToExport, filename);
                });

                c.querySelector('#export-week-btn').addEventListener('click', () => {
                    const today = new Date();
                    const dayOfWeek = today.getDay();
                    const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    const weekStart = new Date(new Date(today.setDate(diff)).setHours(0, 0, 0, 0));
                    
                    const salesToExport = getFilteredSales().filter(s => s.date.toDate() >= weekStart);
                    const filename = `vendas_semana_${new Date().toISOString().split('T')[0]}_${exportVendedorSelect.value}`;
                    exportToCSV(salesToExport, filename);
                });

                c.querySelector('#export-month-btn').addEventListener('click', () => {
                    const today = new Date();
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

                    const salesToExport = getFilteredSales().filter(s => s.date.toDate() >= monthStart);
                    const filename = `vendas_mes_${today.getFullYear()}_${today.getMonth() + 1}_${exportVendedorSelect.value}`;
                    exportToCSV(salesToExport, filename);
                });

                c.querySelector('#export-range-btn').addEventListener('click', () => {
                    const startDateInput = c.querySelector('#start-date').value;
                    const endDateInput = c.querySelector('#end-date').value;

                    if (!startDateInput || !endDateInput) {
                        showToast('Por favor, selecione data de início e fim.', 'error');
                        return;
                    }

                    const startDate = new Date(startDateInput + 'T00:00:00');
                    const endDate = new Date(endDateInput + 'T23:59:59');

                    const salesToExport = getFilteredSales().filter(s => {
                        const saleDate = s.date.toDate();
                        return saleDate >= startDate && saleDate <= endDate;
                    });
                    
                    const filename = `vendas_de_${startDateInput}_a_${endDateInput}_${exportVendedorSelect.value}`;
                    exportToCSV(salesToExport, filename);
                });


                const updateVendedoresList=()=>{
                    const list=c.querySelector('#vendedores-list');
                    list.innerHTML='';
                    const vendedores = state.db.users.filter(u=>u.role==='vendedor');
                    if(vendedores.length === 0){
                        list.innerHTML = '<p class="text-slate-500 text-sm text-center">Nenhum vendedor cadastrado.</p>';
                        return;
                    }
                    vendedores.forEach(v=>{
                        list.innerHTML+=`<li class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-2 rounded-md"><span>${v.name}</span><button data-userid="${v.id}" data-username="${v.name}" class="remove-vendedor-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button></li>`
                    });
                    lucide.createIcons();
                };

                if (state.listeners.users) state.listeners.users();
                state.listeners.users = onSnapshot(query(collection(db, "users")), (snapshot) => {
                     state.db.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     updateVendedoresList();
                });
                
                c.querySelector('#add-vendedor-form').addEventListener('submit',async e=>{
                    e.preventDefault();
                    const n=c.querySelector('#vendedor-name').value.trim(), p=c.querySelector('#vendedor-password').value;
                    if(!n || !p) { showToast('Nome e senha são obrigatórios.','error'); return; }
                    if(state.db.users.some(u=>u.name.toLowerCase()===n.toLowerCase())){showToast('Nome de usuário já existe.','error');return}
                    try {
                        await addDoc(collection(db, "users"), {name:n,password:p,role:'vendedor'});
                        showToast('Vendedor cadastrado!', 'success');
                        e.target.reset();
                    } catch {
                        showToast('Erro ao cadastrar vendedor.', 'error');
                    }
                });

                c.querySelector('#vendedores-list').addEventListener('click', e => {
                    const removeBtn = e.target.closest('.remove-vendedor-btn');
                    if (removeBtn) {
                        const { userid, username } = removeBtn.dataset;
                        showConfirmModal(`Tem certeza que deseja remover o vendedor "${username}"?`, async () => {
                           try {
                               await deleteDoc(doc(db, "users", userid));
                               showToast(`Vendedor "${username}" removido.`, 'success');
                           } catch (error) { showToast('Erro ao remover vendedor.', 'error'); }
                        });
                    }
                });

                c.querySelector('#save-settings-button').addEventListener('click', async ()=> {
                    const newStoreName = c.querySelector('#config-store-name').value;
                    try {
                        await setDoc(doc(db, "settings", "storeConfig"), { storeName: newStoreName }, { merge: true });
                        state.db.settings.storeName = newStoreName;
                        document.getElementById('store-name-sidebar').textContent = newStoreName;
                        document.getElementById('login-store-name').textContent = newStoreName;
                        showToast('Nome da loja salvo!', 'success');
                    } catch (error) { showToast('Erro ao salvar nome da loja.', 'error'); }
                });

                c.querySelector('#save-goals-button').addEventListener('click', async () => {
                    const newGoals = {
                        daily: parseFloat(c.querySelector('#meta-diaria').value) || 0,
                        weekly: parseFloat(c.querySelector('#meta-semanal').value) || 0,
                        monthly: parseFloat(c.querySelector('#meta-mensal').value) || 0,
                    };
                    try {
                        await setDoc(doc(db, "settings", "storeConfig"), { goals: newGoals }, { merge: true });
                        state.db.settings.goals = newGoals;
                        showToast('Metas salvas com sucesso!', 'success');
                    } catch(error) {
                        showToast('Erro ao salvar metas.', 'error');
                    }
                });
                
                 c.querySelector('#delete-all-sales-button').addEventListener('click', async () => {
                    showConfirmModal('TEM CERTEZA? Esta ação removerá PERMANENTEMENTE todas as vendas registradas.', async () => {
                        try {
                            const salesSnapshot = await getDocs(query(collection(db, "sales")));
                            if (salesSnapshot.empty) { showToast('Nenhuma venda para apagar.', 'success'); return; }
                            const batch = writeBatch(db);
                            salesSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                            await batch.commit();
                            showToast('Todas as vendas foram zeradas!', 'success');
                        } catch (error) { showToast('Ocorreu um erro ao zerar as vendas.', 'error'); }
                    });
                 });
            }

            function renderRelatorios() {
                const c = document.getElementById('relatorios-view');
                if(!c) return;
                
                const updateReports = (sales) => {
                    if(vendasChartInstance) {
                        vendasChartInstance.destroy();
                        vendasChartInstance = null;
                    }
                    if(pagamentoChartInstance) {
                        pagamentoChartInstance.destroy();
                        pagamentoChartInstance = null;
                    }

                    const today = new Date();
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)); 
                    startOfWeek.setHours(0, 0, 0, 0);

                    const salesToday = sales.filter(s => s.date.toDate().toDateString() === new Date().toDateString());
                    const salesWeek = sales.filter(s => s.date.toDate() >= startOfWeek);
                    const salesMonth = sales.filter(s => s.date.toDate() >= startOfMonth);

                    c.querySelector('#relatorio-vendas-hoje').textContent = formatCurrency(salesToday.reduce((sum, s) => sum + s.total, 0));
                    c.querySelector('#relatorio-bonus-dia').textContent = salesToday.reduce((sum, s) => sum + s.bonus, 0);
                    c.querySelector('#relatorio-vendas-semana').textContent = formatCurrency(salesWeek.reduce((sum, s) => sum + s.total, 0));
                    c.querySelector('#relatorio-bonus-semana').textContent = salesWeek.reduce((sum, s) => sum + s.bonus, 0);
                    c.querySelector('#relatorio-vendas-mes').textContent = formatCurrency(salesMonth.reduce((sum, s) => sum + s.total, 0));
                    c.querySelector('#relatorio-bonus-mes').textContent = salesMonth.reduce((sum, s) => sum + s.bonus, 0);
                    
                    const salesLast7Days = {};
                    for (let i = 6; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        salesLast7Days[d.toISOString().split('T')[0]] = { label: d.toLocaleDateString('pt-BR', {weekday: 'short'}).slice(0,3), total: 0 };
                    }
                    sales.forEach(sale => {
                        const dayKey = sale.date.toDate().toISOString().split('T')[0];
                        if (salesLast7Days[dayKey]) {
                            salesLast7Days[dayKey].total += sale.total;
                        }
                    });

                    const isDarkMode = document.documentElement.classList.contains('dark');
                    const gridColor = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
                    const textColor = isDarkMode ? '#cbd5e1' : '#475569';
                    
                    const vendasCtx = document.getElementById('vendas-semana-chart')?.getContext('2d');
                    if(vendasCtx) {
                      vendasChartInstance = new Chart(vendasCtx, {
                          type: 'bar',
                          data: { labels: Object.values(salesLast7Days).map(d => d.label), datasets: [{ label: 'Vendas Diárias', data: Object.values(salesLast7Days).map(d => d.total), backgroundColor: '#22c55e', borderRadius: 5 }] },
                          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } } }
                      });
                    }

                    const paymentCounts = sales.reduce((acc, sale) => { acc[sale.paymentMethod] = (acc[sale.paymentMethod] || 0) + sale.total; return acc; }, {});
                    const pagamentosCtx = document.getElementById('pagamento-chart')?.getContext('2d');
                    if(pagamentosCtx) {
                      pagamentoChartInstance = new Chart(pagamentosCtx, {
                          type: 'doughnut',
                          data: { labels: Object.keys(paymentCounts), datasets: [{ data: Object.values(paymentCounts), backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444'], borderColor: isDarkMode ? '#0f172a' : '#f8fafc', borderWidth: 4 }] },
                          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } } } }
                      });
                    }
                };
                
                const isGerente = state.loggedInUser.role === 'gerente';
                const vendedorSelectContainer = c.querySelector('#gerente-relatorios-vendedor-select-container');
                
                let q;
                 if (isGerente) {
                    q = query(collection(db, "sales"), orderBy("date", "desc"));
                } else {
                    q = query(collection(db, "sales"), where("vendedor", "==", state.loggedInUser.name), orderBy("date", "desc"));
                }


                state.listeners.sales = onSnapshot(q, (snapshot) => {
                    const allSales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.db.sales = allSales;
                    
                    if (isGerente) {
                        vendedorSelectContainer.classList.remove('hidden');
                        const vendedorSelect = c.querySelector('#relatorios-vendedor-select');
                        const vendedores = [...new Set(allSales.map(s => s.vendedor))];
                        vendedorSelect.innerHTML = '<option value="total">Relatório Total</option>';
                        vendedores.forEach(name => { vendedorSelect.innerHTML += `<option value="${name}">${name}</option>`; });
                        
                        const newSelect = vendedorSelect.cloneNode(true);
                        vendedorSelect.parentNode.replaceChild(newSelect, vendedorSelect);
                        
                        newSelect.addEventListener('change', (e) => {
                            const salesToReport = e.target.value === 'total' ? allSales : allSales.filter(s => s.vendedor === e.target.value);
                            updateReports(salesToReport);
                        });
                        
                        updateReports(allSales);
                    } else {
                        updateReports(allSales);
                    }
                }, (error) => {
                    console.error("Erro ao buscar relatórios: ", error);
                     if (error.code === 'failed-precondition') {
                         c.innerHTML = `<div class="text-center p-8 text-red-500"><b>Erro de Banco de Dados:</b> A consulta atual precisa de um índice. Por favor, acesse seu painel do Firebase e crie o índice conforme a mensagem de erro no console do navegador.</div>`;
                     }
                });
            }


            const init = () => {
                const theme = localStorage.getItem('theme') || 'light';
                applyTheme(theme);
                const themeToggleHandler = () => {
                    const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                    if(['relatorios', 'metas'].includes(state.currentView) && document.getElementById(`${state.currentView}-view`).classList.contains('active')) {
                         renderViewContent(state.currentView);
                    }
                };
                document.getElementById('theme-toggle').addEventListener('click', themeToggleHandler);
                document.getElementById('theme-toggle-app').addEventListener('click', themeToggleHandler);

                lucide.createIcons();
                loadInitialData();
            };

            init();
        });
    </script>
</body>

</html>

