// firestore.rules - LÓGICA DO PLANO B (ATUALIZADA)

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    match /users/{userId} {
      // NOVA REGRA: Permite que qualquer pessoa LISTE os usuários (necessário para a tela de login).
      allow list: if true;
      // NOVA REGRA: Permite que um usuário logado PEGUE os dados de outro usuário apenas se for da mesma loja.
      allow get: if getUserData().storeId == resource.data.storeId;

      allow update: if request.auth.uid == userId 
                    && request.resource.data.storeId == resource.data.storeId
                    && request.resource.data.role == resource.data.role;

      allow create: if getUserData().role in ['gerente', 'superadmin']
                    && request.resource.data.storeId == getUserData().storeId;
    }

    match /{collection}/{docId} {
        allow read, write: if getUserData().storeId == resource.data.storeId;
    }

    match /settings/{storeId} {
      allow read: if getUserData().storeId == storeId;
      allow write: if false;
    }

    match /stores/{storeId} {
        allow read: if true; // Permite que todos leiam as lojas para a tela de seleção
        allow write: if false;
    }
  }
}